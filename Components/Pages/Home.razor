@page "/"
@using Facturacion.Data
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.EntityFrameworkCore
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject ProtectedLocalStorage LocalStorage
@rendermode InteractiveServer



<div class="m3-container">
    <h1>Sistema de Facturación</h1>

    <div class="m3-card m3-card-elevated">
        <h2>Nueva Factura</h2>

        <div class="m3-text-field">
            <label>Fecha:</label>
            <input type="date" @bind="nuevaFactura.Fecha" @bind:after="GuardarEnStorage" min="@fechaMinima.ToString("yyyy-MM-dd")" />
        </div>

        <div class="m3-text-field">
            <label>👤 Nombre del Cliente:</label>
            <input type="text"
                   value="@nuevaFactura.NombreCliente"
                   @oninput="BuscarClientes"
                   @onblur="@(() => {
                                                             if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente) && string.IsNullOrEmpty(errorFormatoCliente))
                   {
                       nuevaFactura.NombreCliente = FormatearNombre(nuevaFactura.NombreCliente);
                       GuardarEnStorage();
                       StateHasChanged();
                   }
                                                         })"
                   list="listaClientes"
                   placeholder="Escribe el nombre del cliente (mínimo 3 caracteres)..." />
            <datalist id="listaClientes">
                @foreach (var cliente in clientesFiltrados)
                {
                    <option value="@cliente" />
                }
            </datalist>
            @if (!string.IsNullOrEmpty(errorFormatoCliente))
            {
                <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                    ⚠️ @errorFormatoCliente
                </small>
            }
            else if (mostrarErrorCliente)
            {
                <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                    ⚠️ El nombre del cliente debe tener al menos 3 caracteres
                </small>
            }
        </div>

        <hr class="m3-divider" />

        <h3>📦 Artículos <span class="m3-chip">@articulosTemp.Count</span></h3>

        @foreach (var art in articulosTemp.Select((a, i) => new { Articulo = a, Index = i }))
        {
            <div class="m3-card m3-card-outlined" style="margin: 16px 0;">
                <h4>Artículo #@(art.Index + 1)</h4>

                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: end;">
                    <div class="m3-text-field">
                        <label>Nombre:</label>
                        <input type="text"
                               placeholder="Nombre del artículo (mínimo 2 caracteres)"
                               value="@art.Articulo.Nombre"
                               @oninput="@(e => BuscarArticulos(art.Articulo, e))"
                               @onblur="@(() => {
                               if (!string.IsNullOrWhiteSpace(art.Articulo.Nombre) && !nombresArticulosConError.ContainsKey(art.Articulo))
                               {
                                   art.Articulo.Nombre = FormatearNombre(art.Articulo.Nombre);
                                   GuardarEnStorage();
                                   StateHasChanged();
                               }
                           })"
                           list="listaArticulos_@art.Index" />
                    <datalist id="listaArticulos_@art.Index">
                        @foreach (var articulo in articulosFiltrados)
                        {
                            <option value="@articulo.Nombre">$@articulo.Precio.ToString("F2")</option>
                        }
                    </datalist>
                    @if (nombresArticulosConError.ContainsKey(art.Articulo))
                    {
                        <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                            ⚠️ @nombresArticulosConError[art.Articulo]
                        </small>
                    }
                    else if (articulosConError.Contains(art.Articulo))
                    {
                        <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                            ⚠️ Mínimo 2 caracteres
                        </small>
                    }
                </div>

                <div class="m3-text-field">
                    <label>💵 Precio:</label>
                    <input type="text"
                           placeholder="0.00"
                           value="@(preciosTemporales.ContainsKey(art.Articulo) ? preciosTemporales[art.Articulo] : art.Articulo.Precio.ToString("0.##"))"
                           @oninput="@(async (e) => {
                           var valor = e.Value?.ToString() ?? "";

                        
                           preciosTemporales[art.Articulo] = valor;

                           // Verificar si contiene símbolos inválidos
                           if (System.Text.RegularExpressions.Regex.IsMatch(valor, @"[^\d.]"))
                           {
                               articulosConFormatoInvalido[art.Articulo] = "Solo se permiten números y punto decimal";
                               StateHasChanged();
                               return;
                           }

                           // Verificar si hay más de un punto decimal
                           if (valor.Count(c => c == '.') > 1)
                           {
                               articulosConFormatoInvalido[art.Articulo] = "Solo se permite un punto decimal";
                               StateHasChanged();
                               return;
                           }

                           // Limpiar error de formato inválido si existía
                           articulosConFormatoInvalido.Remove(art.Articulo);

                           if (string.IsNullOrWhiteSpace(valor))
                           {
                               art.Articulo.Precio = 0;
                               articulosConPrecioNegativo.Remove(art.Articulo);
                               await GuardarEnStorage();
                               StateHasChanged();
                               return;
                           }

                           if (decimal.TryParse(valor, System.Globalization.NumberStyles.AllowDecimalPoint,
                               System.Globalization.CultureInfo.InvariantCulture, out var precio))
                           {
                               if (precio < 0)
                               {
                                   articulosConPrecioNegativo.Add(art.Articulo);
                               }
                               else
                               {
                                   articulosConPrecioNegativo.Remove(art.Articulo);
                               }
                               art.Articulo.Precio = precio;
                               await GuardarEnStorage();
                           }
                           StateHasChanged();
                                                                                     })" />
                    @if (articulosConFormatoInvalido.ContainsKey(art.Articulo))
                    {
                        <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                            ⚠️ @articulosConFormatoInvalido[art.Articulo]
                        </small>
                    }
                    else if (articulosConPrecioNegativo.Contains(art.Articulo))
                    {
                        <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                            ⚠️ El precio no puede ser negativo
                        </small>
                    }
                </div>

                <div class="m3-button-group">
                    <button class="m3-button m3-button-outlined" @onclick="@(() => LimpiarArticulo(art.Articulo))">🧹 Limpiar</button>
                    <button class="m3-button m3-button-error" @onclick="@(() => EliminarArticulo(art.Articulo))">🗑️ Eliminar</button>
                </div>
            </div>
        </div>
                }

        <button class="m3-button m3-button-tonal" @onclick="AgregarArticulo">➕ Agregar Artículo</button>

        <hr class="m3-divider" />

        <div class="m3-card" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
            <h3 style="margin: 0; color: inherit;">💰 Total: $@articulosTemp.Sum(a => a.Precio).ToString("F2")</h3>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="@(mensaje.Contains("exitosamente") ? "m3-message m3-message-success" : "m3-message m3-message-error")">
                @mensaje
            </div>
        }

        <button class="m3-button m3-button-filled" @onclick="GuardarFactura" style="width: 100%; margin-top: 16px;">
            💾 Guardar Factura
        </button>
    </div>

    <div class="m3-button-group" style="margin-top: 24px;">
        <button class="m3-button m3-button-outlined" @onclick="IrAFacturas">📋 Ver Facturas Registradas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAReportes">📊 Reportes SAT</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAConsultas">🔍 Consultas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAArchivadas">📦 Facturas Archivadas</button>
    </div>
</div>

@code {
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private List<Articulo> articulosTemp = new() { new Articulo() };
    private string mensaje = "";
    private DateTime fechaMinima = DateTime.Now.AddDays(-300);
    private bool cargaInicial = true;

    private List<string> todosLosClientes = new();
    private List<string> clientesFiltrados = new();
    private List<ArticuloHistorico> todosLosArticulos = new();
    private List<ArticuloHistorico> articulosFiltrados = new();

    private bool mostrarErrorCliente = false;
    private HashSet<Articulo> articulosConError = new();
    private HashSet<Articulo> articulosConPrecioNegativo = new();
    private Dictionary<Articulo, string> articulosConFormatoInvalido = new();
    private Dictionary<Articulo, string> preciosTemporales = new();
    private Dictionary<Articulo, string> nombresArticulosConError = new();
    private string errorFormatoCliente = "";

    private const int LONGITUD_MINIMA_CLIENTE = 3;
    private const int LONGITUD_MINIMA_ARTICULO = 2;

    private string FormatearNombre(string nombre)
    {
        if (string.IsNullOrWhiteSpace(nombre))
            return "";

      
        nombre = System.Text.RegularExpressions.Regex.Replace(nombre, @"[^\p{L}\p{N}\s\-']", "");

        nombre = System.Text.RegularExpressions.Regex.Replace(nombre, @"\s+", " ");

        var palabras = nombre.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var palabrasFormateadas = palabras.Select(p =>
        {
            if (p.Length == 0) return p;
            return char.ToUpper(p[0]) + p.Substring(1).ToLower();
        });

        return string.Join(" ", palabrasFormateadas).Trim();
    }

    private bool ValidarCaracteresNombre(string nombre)
    {
    
        return !System.Text.RegularExpressions.Regex.IsMatch(nombre, @"[^\p{L}\p{N}\s\-']");
    }

    private async Task ValidarPrecio()
    {
        // Validar precios negativos
        articulosConPrecioNegativo.Clear();
        foreach (var art in articulosTemp)
        {
            if (art.Precio < 0)
            {
                articulosConPrecioNegativo.Add(art);
                art.Precio = 0; // Resetear a 0
            }
        }

        await GuardarEnStorage();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarHistorico();
            await CargarDesdeStorage();
            cargaInicial = false;
            StateHasChanged();
        }
    }

    private async Task CargarHistorico()
    {
        todosLosClientes = await DbContext.Facturas
            .Where(f => !string.IsNullOrWhiteSpace(f.NombreCliente) && !f.Archivada)
            .Select(f => f.NombreCliente)
            .Distinct()
            .ToListAsync();

        clientesFiltrados = todosLosClientes;

        todosLosArticulos = await DbContext.Articulos
            .Where(a => !string.IsNullOrWhiteSpace(a.Nombre) && !DbContext.Facturas.Any(f => f.Id == a.FacturaId && f.Archivada))
            .GroupBy(a => a.Nombre)
            .Select(g => new ArticuloHistorico
            {
                Nombre = g.Key,
                Precio = g.OrderByDescending(a => a.Id).First().Precio
            })
            .ToListAsync();

        articulosFiltrados = todosLosArticulos;
    }

    private void BuscarClientes(ChangeEventArgs e)
    {
        var busqueda = e.Value?.ToString() ?? "";

        if (!string.IsNullOrWhiteSpace(busqueda) && !ValidarCaracteresNombre(busqueda))
        {
            errorFormatoCliente = "No se permiten caracteres especiales como [], {}, <>";
            StateHasChanged();
            return;
        }

        errorFormatoCliente = "";
        nuevaFactura.NombreCliente = busqueda;

        // Validar longitud
        mostrarErrorCliente = !string.IsNullOrWhiteSpace(busqueda) && busqueda.Trim().Length < LONGITUD_MINIMA_CLIENTE;

        if (string.IsNullOrWhiteSpace(busqueda))
        {
            clientesFiltrados = todosLosClientes;
        }
        else
        {
            clientesFiltrados = todosLosClientes
                .Where(c => c.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        GuardarEnStorage();
    }

    private void BuscarArticulos(Articulo articulo, ChangeEventArgs e)
    {
        var busqueda = e.Value?.ToString() ?? "";


        if (!string.IsNullOrWhiteSpace(busqueda) && !ValidarCaracteresNombre(busqueda))
        {
            nombresArticulosConError[articulo] = "No se permiten caracteres especiales como [], {}, <>";
            StateHasChanged();
            return;
        }

        nombresArticulosConError.Remove(articulo);
        articulo.Nombre = busqueda;

        // Validar longitud
        if (!string.IsNullOrWhiteSpace(busqueda) && busqueda.Trim().Length < LONGITUD_MINIMA_ARTICULO)
        {
            articulosConError.Add(articulo);
        }
        else
        {
            articulosConError.Remove(articulo);
        }

        if (string.IsNullOrWhiteSpace(busqueda))
        {
            articulosFiltrados = todosLosArticulos;
        }
        else
        {
            articulosFiltrados = todosLosArticulos
                .Where(a => a.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        var coincidencia = todosLosArticulos.FirstOrDefault(a =>
            a.Nombre.Equals(busqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidencia != null && articulo.Precio == 0)
        {
            articulo.Precio = coincidencia.Precio;
            preciosTemporales[articulo] = coincidencia.Precio.ToString("0.##");
        }

        GuardarEnStorage();
    }

    private async Task CargarDesdeStorage()
    {
        try
        {
            var fechaGuardada = await LocalStorage.GetAsync<DateTime>("factura_fecha");
            var clienteGuardado = await LocalStorage.GetAsync<string>("factura_cliente");
            var articulosGuardados = await LocalStorage.GetAsync<List<ArticuloDto>>("factura_articulos");

            if (fechaGuardada.Success && fechaGuardada.Value != default)
            {
                nuevaFactura.Fecha = fechaGuardada.Value;
            }

            if (clienteGuardado.Success && !string.IsNullOrWhiteSpace(clienteGuardado.Value))
            {
                nuevaFactura.NombreCliente = clienteGuardado.Value;
            }

            if (articulosGuardados.Success && articulosGuardados.Value?.Any() == true)
            {
                articulosTemp = articulosGuardados.Value.Select(dto => new Articulo
                {
                    Nombre = dto.Nombre,
                    Precio = dto.Precio
                }).ToList();
            }
        }
        catch { }
    }

    private async Task GuardarEnStorage()
    {
        if (cargaInicial) return;

        try
        {
            await LocalStorage.SetAsync("factura_fecha", nuevaFactura.Fecha);
            await LocalStorage.SetAsync("factura_cliente", nuevaFactura.NombreCliente ?? "");

            var articulosDto = articulosTemp.Select(a => new ArticuloDto
            {
                Nombre = a.Nombre ?? "",
                Precio = a.Precio
            }).ToList();

            await LocalStorage.SetAsync("factura_articulos", articulosDto);
        }
        catch { }
    }

    private async Task LimpiarStorage()
    {
        try
        {
            await LocalStorage.DeleteAsync("factura_fecha");
            await LocalStorage.DeleteAsync("factura_cliente");
            await LocalStorage.DeleteAsync("factura_articulos");
        }
        catch { }
    }

    private async Task AgregarArticulo()
    {
        articulosTemp.Add(new Articulo());
        await GuardarEnStorage();
    }

    private async Task EliminarArticulo(Articulo art)
    {
        if (articulosTemp.Count > 1)
        {
            articulosTemp.Remove(art);
            articulosConError.Remove(art);
            articulosConPrecioNegativo.Remove(art);
            articulosConFormatoInvalido.Remove(art);
            preciosTemporales.Remove(art);
            nombresArticulosConError.Remove(art);
            await GuardarEnStorage();
        }
        else
        {
            mensaje = "No se puede eliminar artículo 1, debe tener al menos un artículo para facturar";
        }
    }

    private async Task LimpiarArticulo(Articulo art)
    {
        art.Nombre = "";
        art.Precio = 0;
        articulosConError.Remove(art);
        articulosConPrecioNegativo.Remove(art);
        articulosConFormatoInvalido.Remove(art);
        preciosTemporales.Remove(art);
        nombresArticulosConError.Remove(art);
        await GuardarEnStorage();
    }

    private async Task GuardarFactura()
    {
        mensaje = "";

        // PRIMERO: Verificar si hay errores de formato inválido en precios
        if (articulosConFormatoInvalido.Any())
        {
            mensaje = "Hay artículos con formato de precio inválido. Solo se permiten números y punto decimal.";
            StateHasChanged();
            return;
        }

        // Verificar si hay errores de formato en nombres de artículos
        if (nombresArticulosConError.Any())
        {
            mensaje = "Hay nombres de artículos con caracteres no permitidos.";
            StateHasChanged();
            return;
        }

        // Verificar si hay error de formato en nombre de cliente
        if (!string.IsNullOrEmpty(errorFormatoCliente))
        {
            mensaje = "El nombre del cliente contiene caracteres no permitidos.";
            StateHasChanged();
            return;
        }

        // Ahora sí limpiamos los errores para re-validar
        mostrarErrorCliente = false;
        articulosConError.Clear();
        articulosConPrecioNegativo.Clear();

        // Validar que no haya caracteres inválidos en el cliente antes de formatear
        if (!string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente))
        {
            if (!ValidarCaracteresNombre(nuevaFactura.NombreCliente))
            {
                mensaje = "El nombre del cliente contiene caracteres no permitidos.";
                errorFormatoCliente = "No se permiten caracteres especiales como [], {}, <>";
                StateHasChanged();
                return;
            }
            // Solo formatear si no hay errores
            nuevaFactura.NombreCliente = FormatearNombre(nuevaFactura.NombreCliente);
        }

        // Validar nombre del cliente
        if (string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            mostrarErrorCliente = true;
            return;
        }

        if (nuevaFactura.NombreCliente.Trim().Length < LONGITUD_MINIMA_CLIENTE)
        {
            mensaje = $"El nombre del cliente debe tener al menos {LONGITUD_MINIMA_CLIENTE} caracteres";
            mostrarErrorCliente = true;
            return;
        }

        // Validar artículos
        var articulosValidos = new List<Articulo>();
        var hayErroresArticulos = false;
        var hayPreciosNegativos = false;

        foreach (var art in articulosTemp)
        {
            // Validar que no haya caracteres inválidos en el artículo antes de formatear
            if (!string.IsNullOrWhiteSpace(art.Nombre))
            {
                if (!ValidarCaracteresNombre(art.Nombre))
                {
                    mensaje = "Hay nombres de artículos con caracteres no permitidos.";
                    nombresArticulosConError[art] = "No se permiten caracteres especiales como [], {}, <>";
                    StateHasChanged();
                    return;
                }
                // Solo formatear si no hay errores
                art.Nombre = FormatearNombre(art.Nombre);
            }

            // Validar precio negativo
            if (art.Precio < 0)
            {
                articulosConPrecioNegativo.Add(art);
                hayPreciosNegativos = true;
                continue;
            }

            if (string.IsNullOrWhiteSpace(art.Nombre))
                continue;

            if (art.Nombre.Trim().Length < LONGITUD_MINIMA_ARTICULO)
            {
                articulosConError.Add(art);
                hayErroresArticulos = true;
                continue;
            }

            if (art.Precio > 0)
            {
                articulosValidos.Add(art);
            }
        }

        if (hayPreciosNegativos)
        {
            mensaje = "Los precios no pueden ser negativos";
            return;
        }

        if (hayErroresArticulos)
        {
            mensaje = $"Los nombres de artículos deben tener al menos {LONGITUD_MINIMA_ARTICULO} caracteres";
            return;
        }

        if (!articulosValidos.Any())
        {
            mensaje = "Debe agregar al menos un artículo válido con nombre y precio";
            return;
        }

        var factura = new Factura
        {
            Fecha = nuevaFactura.Fecha,
            NombreCliente = nuevaFactura.NombreCliente.Trim(),
            Articulos = articulosValidos.Select(a => new Articulo
            {
                Nombre = a.Nombre.Trim(),
                Precio = a.Precio
            }).ToList(),
            Archivada = false
        };

        DbContext.Facturas.Add(factura);
        await DbContext.SaveChangesAsync();
        mensaje = "Factura guardada exitosamente";

        await CargarHistorico();
        await LimpiarStorage();

        nuevaFactura = new() { Fecha = DateTime.Now };
        articulosTemp = new() { new Articulo() };
        articulosConError.Clear();
        articulosConPrecioNegativo.Clear();
        articulosConFormatoInvalido.Clear();
        preciosTemporales.Clear();
        nombresArticulosConError.Clear();
        errorFormatoCliente = "";
    }

    private void IrAFacturas()
    {
        Navigation.NavigateTo("/facturas");
    }

    private void IrAReportes()
    {
        Navigation.NavigateTo("/reportes");
    }

    private void IrAConsultas()
    {
        Navigation.NavigateTo("/consultas");
    }

    private void IrAArchivadas()
    {
        Navigation.NavigateTo("/archivadas");
    }

    private class ArticuloDto
    {
        public string Nombre { get; set; } = "";
        public decimal Precio { get; set; }
    }

    private class ArticuloHistorico
    {
        public string Nombre { get; set; } = "";
        public decimal Precio { get; set; }
    }
}
