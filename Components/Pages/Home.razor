@page "/"
@using Facturacion.Data
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.EntityFrameworkCore
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject ProtectedLocalStorage LocalStorage
@rendermode InteractiveServer

<link rel="stylesheet" href="/css/m3-styles.css" />

<div class="m3-container">
    <h1>Sistema de Facturación</h1>

    <div class="m3-card m3-card-elevated">
        <h2>Nueva Factura</h2>

        <div class="m3-text-field">
            <label>Fecha:</label>
            <input type="date" @bind="nuevaFactura.Fecha" @bind:after="GuardarEnStorage" min="@fechaMinima.ToString("yyyy-MM-dd")" />
        </div>

        <div class="m3-text-field">
            <label>👤 Nombre del Cliente:</label>
            <input type="text"
                   @bind="nuevaFactura.NombreCliente"
                   @bind:after="GuardarEnStorage"
                   @oninput="BuscarClientes"
                   list="listaClientes"
                   placeholder="Escribe el nombre del cliente..." />
            <datalist id="listaClientes">
                @foreach (var cliente in clientesFiltrados)
                {
                    <option value="@cliente" />
                }
            </datalist>
        </div>

        <hr class="m3-divider" />

        <h3>📦 Artículos <span class="m3-chip">@articulosTemp.Count</span></h3>

        @foreach (var art in articulosTemp.Select((a, i) => new { Articulo = a, Index = i }))
        {
            <div class="m3-card m3-card-outlined" style="margin: 16px 0;">
                <h4>Artículo #@(art.Index + 1)</h4>

                <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: end;">
                    <div class="m3-text-field">
                        <label>Nombre:</label>
                        <input type="text"
                               placeholder="Nombre del artículo"
                               value="@art.Articulo.Nombre"
                               @oninput="@(e => BuscarArticulos(art.Articulo, e))"
                               list="listaArticulos_@art.Index" />
                        <datalist id="listaArticulos_@art.Index">
                            @foreach (var articulo in articulosFiltrados)
                            {
                                <option value="@articulo.Nombre">$@articulo.Precio.ToString("F2")</option>
                            }
                        </datalist>
                    </div>

                    <div class="m3-text-field">
                        <label>💵 Precio:</label>
                        <input type="number" step="0.01" placeholder="0.00" @bind="art.Articulo.Precio" @bind:after="GuardarEnStorage" />
                    </div>

                    <div class="m3-button-group">
                        <button class="m3-button m3-button-outlined" @onclick="() => LimpiarArticulo(art.Articulo)">🧹 Limpiar</button>
                        <button class="m3-button m3-button-error" @onclick="() => EliminarArticulo(art.Articulo)">🗑️ Eliminar</button>
                    </div>
                </div>
            </div>
        }

        <button class="m3-button m3-button-tonal" @onclick="AgregarArticulo">➕ Agregar Artículo</button>

        <hr class="m3-divider" />

        <div class="m3-card" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
            <h3 style="margin: 0; color: inherit;">💰 Total: $@articulosTemp.Sum(a => a.Precio).ToString("F2")</h3>
        </div>

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="@(mensaje.Contains("exitosamente") ? "m3-message m3-message-success" : "m3-message m3-message-error")">
                @mensaje
            </div>
        }

        <button class="m3-button m3-button-filled" @onclick="GuardarFactura" style="width: 100%; margin-top: 16px;">
            💾 Guardar Factura
        </button>
    </div>

    <div class="m3-button-group" style="margin-top: 24px;">
        <button class="m3-button m3-button-outlined" @onclick="IrAFacturas">📋 Ver Facturas Registradas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAReportes">📊 Reportes SAT</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAConsultas">🔍 Consultas</button>
    </div>
</div>

@code {
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private List<Articulo> articulosTemp = new() { new Articulo() };
    private string mensaje = "";
    private DateTime fechaMinima = DateTime.Now.AddDays(-300);
    private bool cargaInicial = true;

    private List<string> todosLosClientes = new();
    private List<string> clientesFiltrados = new();
    private List<ArticuloHistorico> todosLosArticulos = new();
    private List<ArticuloHistorico> articulosFiltrados = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CargarHistorico();
            await CargarDesdeStorage();
            cargaInicial = false;
            StateHasChanged();
        }
    }

    private async Task CargarHistorico()
    {
        todosLosClientes = await DbContext.Facturas
            .Where(f => !string.IsNullOrWhiteSpace(f.NombreCliente))
            .Select(f => f.NombreCliente)
            .Distinct()
            .ToListAsync();

        clientesFiltrados = todosLosClientes;

        todosLosArticulos = await DbContext.Articulos
            .Where(a => !string.IsNullOrWhiteSpace(a.Nombre))
            .GroupBy(a => a.Nombre)
            .Select(g => new ArticuloHistorico
            {
                Nombre = g.Key,
                Precio = g.OrderByDescending(a => a.Id).First().Precio
            })
            .ToListAsync();

        articulosFiltrados = todosLosArticulos;
    }

    private void BuscarClientes(ChangeEventArgs e)
    {
        var busqueda = e.Value?.ToString() ?? "";
        nuevaFactura.NombreCliente = busqueda;

        if (string.IsNullOrWhiteSpace(busqueda))
        {
            clientesFiltrados = todosLosClientes;
        }
        else
        {
            clientesFiltrados = todosLosClientes
                .Where(c => c.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        GuardarEnStorage();
    }

    private void BuscarArticulos(Articulo articulo, ChangeEventArgs e)
    {
        var busqueda = e.Value?.ToString() ?? "";
        articulo.Nombre = busqueda;

        if (string.IsNullOrWhiteSpace(busqueda))
        {
            articulosFiltrados = todosLosArticulos;
        }
        else
        {
            articulosFiltrados = todosLosArticulos
                .Where(a => a.Nombre.Contains(busqueda, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        var coincidencia = todosLosArticulos.FirstOrDefault(a =>
            a.Nombre.Equals(busqueda, StringComparison.OrdinalIgnoreCase));

        if (coincidencia != null && articulo.Precio == 0)
        {
            articulo.Precio = coincidencia.Precio;
        }

        GuardarEnStorage();
    }

    private async Task CargarDesdeStorage()
    {
        try
        {
            var fechaGuardada = await LocalStorage.GetAsync<DateTime>("factura_fecha");
            var clienteGuardado = await LocalStorage.GetAsync<string>("factura_cliente");
            var articulosGuardados = await LocalStorage.GetAsync<List<ArticuloDto>>("factura_articulos");

            if (fechaGuardada.Success && fechaGuardada.Value != default)
            {
                nuevaFactura.Fecha = fechaGuardada.Value;
            }

            if (clienteGuardado.Success && !string.IsNullOrWhiteSpace(clienteGuardado.Value))
            {
                nuevaFactura.NombreCliente = clienteGuardado.Value;
            }

            if (articulosGuardados.Success && articulosGuardados.Value?.Any() == true)
            {
                articulosTemp = articulosGuardados.Value.Select(dto => new Articulo
                {
                    Nombre = dto.Nombre,
                    Precio = dto.Precio
                }).ToList();
            }
        }
        catch { }
    }

    private async Task GuardarEnStorage()
    {
        if (cargaInicial) return;

        try
        {
            await LocalStorage.SetAsync("factura_fecha", nuevaFactura.Fecha);
            await LocalStorage.SetAsync("factura_cliente", nuevaFactura.NombreCliente ?? "");

            var articulosDto = articulosTemp.Select(a => new ArticuloDto
            {
                Nombre = a.Nombre ?? "",
                Precio = a.Precio
            }).ToList();

            await LocalStorage.SetAsync("factura_articulos", articulosDto);
        }
        catch { }
    }

    private async Task LimpiarStorage()
    {
        try
        {
            await LocalStorage.DeleteAsync("factura_fecha");
            await LocalStorage.DeleteAsync("factura_cliente");
            await LocalStorage.DeleteAsync("factura_articulos");
        }
        catch { }
    }

    private async Task AgregarArticulo()
    {
        articulosTemp.Add(new Articulo());
        await GuardarEnStorage();
    }

    private async Task EliminarArticulo(Articulo art)
    {
        if (articulosTemp.Count > 1)
        {
            articulosTemp.Remove(art);
            await GuardarEnStorage();
        }
        else
        {
            mensaje = "No se puede eliminar artículo 1, debe tener al menos un artículo para facturar";
        }
    }

    private async Task LimpiarArticulo(Articulo art)
    {
        art.Nombre = "";
        art.Precio = 0;
        await GuardarEnStorage();
    }

    private async Task GuardarFactura()
    {
        mensaje = "";

        if (string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            return;
        }

        var articulosValidos = articulosTemp.Where(a =>
            !string.IsNullOrWhiteSpace(a.Nombre) && a.Precio > 0).ToList();

        if (!articulosValidos.Any())
        {
            mensaje = "Debe agregar al menos un artículo válido con nombre y precio";
            return;
        }

        var factura = new Factura
        {
            Fecha = nuevaFactura.Fecha,
            NombreCliente = nuevaFactura.NombreCliente,
            Articulos = articulosValidos
        };

        DbContext.Facturas.Add(factura);
        await DbContext.SaveChangesAsync();
        mensaje = "Factura guardada exitosamente";

        await CargarHistorico();
        await LimpiarStorage();

        nuevaFactura = new() { Fecha = DateTime.Now };
        articulosTemp = new() { new Articulo() };
    }

    private void IrAFacturas() => Navigation.NavigateTo("/facturas");
    private void IrAReportes() => Navigation.NavigateTo("/reportes");
    private void IrAConsultas() => Navigation.NavigateTo("/consultas");

    private class ArticuloDto
    {
        public string Nombre { get; set; } = "";
        public decimal Precio { get; set; }
    }

    private class ArticuloHistorico
    {
        public string Nombre { get; set; } = "";
        public decimal Precio { get; set; }
    }
}