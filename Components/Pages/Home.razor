@page "/"
@using Facturacion.Data
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<h1>Sistema de Facturación</h1>

<div style="margin-bottom: 20px;">
    <button @onclick="IrAFacturas" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Ver Facturas Registradas
    </button>
</div>

<h2>Nueva Factura</h2>

<div>
    <label>Fecha:</label>
    <input type="date" @bind="nuevaFactura.Fecha" />
</div>

<div>
    <label>Nombre del Cliente:</label>
    <input type="text" @bind="nuevaFactura.NombreCliente" style="width: 300px;" />
</div>

<h3>Artículos (Total: @articulosTemp.Count)</h3>
@foreach (var art in articulosTemp.Select((a, i) => new { Articulo = a, Index = i }))
{
    <div style="margin: 10px 0;">
        <h4>Artículo #@(art.Index + 1)</h4>
        <input type="text" placeholder="Nombre artículo" @bind="art.Articulo.Nombre" style="width: 200px;" />
        <b> Precio:</b> <input type="number" step="0.01" placeholder="Precio" @bind="art.Articulo.Precio" style="width: 100px;" />
        <button @onclick="() => EliminarArticulo(art.Articulo)">Eliminar</button>
        <button @onclick="() => LimpiarArticulo(art.Articulo)">Limpiar</button>
    </div>
}

<button @onclick="AgregarArticulo">Agregar Artículo</button>

<div style="margin: 20px 0;">
    <h4>Total: $@articulosTemp.Sum(a => a.Precio).ToString("F2")</h4>
</div>

<button @onclick="GuardarFactura">Guardar Factura</button>

@if (!string.IsNullOrEmpty(mensaje))
{
    <p style="color: green; font-weight: bold;">@mensaje</p>
}

@code {
    private Factura nuevaFactura = new() { Fecha = DateTime.Now };
    private List<Articulo> articulosTemp = new() { new Articulo() };
    private string mensaje = "";

    private void AgregarArticulo()
    {
        articulosTemp.Add(new Articulo());
    }

    private void EliminarArticulo(Articulo art)
    {
        if (articulosTemp.Count > 1)
        {
            articulosTemp.Remove(art);
        }
        else
        {
            mensaje = "Debe haber al menos un artículo";
        }
    }

    private void LimpiarArticulo(Articulo art)
    {
        art.Nombre = "";
        art.Precio = 0;
    }

    private async Task GuardarFactura()
    {
        mensaje = "";

        if (string.IsNullOrWhiteSpace(nuevaFactura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            return;
        }

        var articulosValidos = articulosTemp.Where(a =>
            !string.IsNullOrWhiteSpace(a.Nombre) && a.Precio > 0).ToList();

        if (!articulosValidos.Any())
        {
            mensaje = "Debe agregar al menos un artículo válido con nombre y precio";
            return;
        }

        var factura = new Factura
        {
            Fecha = nuevaFactura.Fecha,
            NombreCliente = nuevaFactura.NombreCliente,
            Articulos = articulosValidos
        };

        DbContext.Facturas.Add(factura);
        await DbContext.SaveChangesAsync();

        mensaje = "Factura guardada exitosamente";
        nuevaFactura = new() { Fecha = DateTime.Now };
        articulosTemp = new() { new Articulo() };
    }

    private void IrAFacturas()
    {
        Navigation.NavigateTo("/facturas");
    }
}
