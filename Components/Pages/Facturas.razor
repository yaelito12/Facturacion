@page "/facturas"
@using Facturacion.Data
@using Facturacion.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject FacturaNavigationService NavService
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable



<div class="m3-container">
    <h1>📋 Facturas Registradas</h1>

    <div class="m3-button-group">
        <button class="m3-button m3-button-outlined" @onclick="IrAHome">← Volver a Nueva Factura</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAReportes">📊 Ver Reportes</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAConsultas">🔍 Ver Consultas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrArchivadas">📦 Facturas Archivadas</button>
    </div>

    @if (facturas == null)
    {
        <div class="m3-card" style="text-align: center; padding: 48px;">
            <p style="color: var(--md-sys-color-on-surface-variant);">Cargando facturas...</p>
        </div>
    }
    else if (!facturas.Any())
    {
        <div class="m3-card m3-card-elevated" style="text-align: center; padding: 48px;">
            <h3>No hay facturas registradas</h3>
            <p style="color: var(--md-sys-color-on-surface-variant); margin: 16px 0;">
                Comienza creando tu primera factura
            </p>
            <button class="m3-button m3-button-filled" @onclick="IrAHome" style="margin-top: 16px;">
                ➕ Crear Nueva Factura
            </button>
        </div>
    }
    else
    {
        <div class="m3-card m3-card-elevated" style="padding: 0; overflow: hidden;">
            <div style="padding: 24px; background-color: var(--md-sys-color-surface-container-high);">
                <h2 style="margin: 0;">Total de facturas: <span class="m3-chip">@facturas.Count</span></h2>
            </div>

            <table class="m3-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th style="text-align: right;">Total</th>
                        <th style="text-align: center;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var f in facturas)
                    {
                        <tr>
                            <td><strong>#@f.Id</strong></td>
                            <td>@f.Fecha.ToString("dd/MM/yyyy")</td>
                            <td>@f.NombreCliente</td>
                            <td style="text-align: right;"><strong>$@f.Total.ToString("F2")</strong></td>
                            <td style="text-align: center;">
                                <div class="m3-button-group" style="justify-content: center;">
                                    <button class="m3-button m3-button-tonal" @onclick="@(() => VerDetalle(f.Id))">
                                        👁️ Ver
                                    </button>
                                    <button class="m3-button m3-button-outlined" @onclick="@(() => ArchivarFactura(f.Id))">
                                        📥 Archivar
                                    </button>
                                    <button class="m3-button m3-button-error" @onclick="@(() => EliminarFactura(f.Id))">
                                        🗑️ Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3"><strong>TOTAL GENERAL</strong></td>
                        <td style="text-align: right;"><strong>$@facturas.Sum(f => f.Total).ToString("F2")</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
</div>

@code {
    private List<Factura>? facturas;

    protected override async Task OnInitializedAsync()
    {
        await CargarFacturas();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BloquearBotonesNavegador();
        }
    }

    private async Task CargarFacturas()
    {
        facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada)
            .OrderByDescending(f => f.Fecha)
            .ToListAsync();
    }

    private async Task VerDetalle(int id)
    {
        var token = NavService.GenerarTokenNavegacion(id);
        await JS.InvokeVoidAsync("eval", $"sessionStorage.setItem('factura_token_{id}', '{token}')");
        Navigation.NavigateTo($"/factura/{id}?token={token}");
    }

    private async Task ArchivarFactura(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm",
            $"¿Deseas archivar la factura #{id}? No aparecerá en reportes ni consultas.");

        if (!confirmar)
            return;

        var factura = await DbContext.Facturas.FindAsync(id);
        if (factura != null)
        {
            factura.Archivada = true;
            await DbContext.SaveChangesAsync();
            await CargarFacturas();
        }
    }

    private async Task EliminarFactura(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm",
            $"¿Estás seguro de que deseas eliminar la factura #{id}?");

        if (!confirmar)
            return;

        var factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == id);

        if (factura != null)
        {
            DbContext.Facturas.Remove(factura);
            await DbContext.SaveChangesAsync();
            await CargarFacturas();
        }
    }

    private async Task IrAHome()
    {
        await DesbloquearBotonesNavegador();
        Navigation.NavigateTo("/");
    }

    private void IrAReportes()
    {
        Navigation.NavigateTo("/reportes");
    }

    private void IrAConsultas()
    {
        Navigation.NavigateTo("/consultas");
    }
    private void IrArchivadas()
    {
        Navigation.NavigateTo("/archivadas");
    }

    private async Task BloquearBotonesNavegador()
    {
        await JS.InvokeVoidAsync("eval", @"
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.pushState(null, null, location.href);
            };
        ");
    }

    private async Task DesbloquearBotonesNavegador()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                window.onpopstate = null;
            ");
        }
        catch { }
    }

    public void Dispose()
    {
    }
}