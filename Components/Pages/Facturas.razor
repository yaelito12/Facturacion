@page "/facturas"
@using Facturacion.Data
@using Facturacion.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject FacturaNavigationService NavService
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

<h1>Facturas Registradas</h1>

<div style="margin-bottom: 20px;">
    <button @onclick="IrAHome">← Volver a Nueva Factura</button>
</div>

@if (facturas == null)
{
    <p>Cargando...</p>
}
else if (!facturas.Any())
{
    <p>No hay facturas registradas</p>
}
else
{
    <table border="1" cellpadding="10" cellspacing="0">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var f in facturas)
            {
                <tr>
                    <td>@f.Id</td>
                    <td>@f.Fecha.ToShortDateString()</td>
                    <td>@f.NombreCliente</td>
                    <td>$@f.Total.ToString("F2")</td>
                    <td>
                        <button @onclick="() => VerDetalle(f.Id)">Ver Detalle</button>
                        <button @onclick="() => EliminarFactura(f.Id)">Eliminar</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Factura>? facturas;
    private string mensaje = "";

    protected override async Task OnInitializedAsync()
    {
        await CargarFacturas();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await BloquearBotonesNavegador();
        }
    }

    private async Task CargarFacturas()
    {
        facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .OrderByDescending(f => f.Fecha)
            .ToListAsync();
    }

    private async Task VerDetalle(int id)
    {
        // Generar token de navegación autorizada
        var token = NavService.GenerarTokenNavegacion(id);

        // Guardar en sessionStorage de forma SÍNCRONA usando eval
        await JS.InvokeVoidAsync("eval", $"sessionStorage.setItem('factura_token_{id}', '{token}')");

        // Navegar
        Navigation.NavigateTo($"/factura/{id}?token={token}");
    }

    private async Task EliminarFactura(int id)
    {
        var factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == id);

        if (factura != null)
        {
            DbContext.Facturas.Remove(factura);
            await DbContext.SaveChangesAsync();
            await CargarFacturas();
        }
    }

    private async Task IrAHome()
    {
        await DesbloquearBotonesNavegador();
        Navigation.NavigateTo("/");
    }

    private async Task BloquearBotonesNavegador()
    {
        await JS.InvokeVoidAsync("eval", @"
            // Bloquear botones atrás y adelante
            history.pushState(null, null, location.href);
            window.onpopstate = function() {
                history.pushState(null, null, location.href);
            };
        ");
    }

    private async Task DesbloquearBotonesNavegador()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                window.onpopstate = null;
            ");
        }
        catch
        {
   
        }
    }

    public void Dispose()
    {
      
    }
}