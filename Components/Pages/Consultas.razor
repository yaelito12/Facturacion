@page "/consultas"
@using Facturacion.Data
@using Microsoft.EntityFrameworkCore
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@rendermode InteractiveServer

<h1>📊 Consultas Inteligentes</h1>
<p>Explota la información de tu negocio con análisis detallados</p>

<button @onclick="VolverInicio" style="margin-bottom: 20px;">← Volver al Inicio</button>

<div style="margin: 20px 0;">
    <h3>Selecciona una consulta:</h3>
    <select @onchange="CambiarConsulta" style="width: 100%; padding: 10px; font-size: 16px;">
        <option value="">-- Selecciona una consulta --</option>
        <option value="total_facturacion">📈 Resumen General de Facturación</option>
        <option value="articulo_mas_vendido">📦 Artículo Más Vendido</option>
        <option value="cliente_mayor_gasto">👥 Cliente que Más Ha Gastado</option>
        <option value="mes_mas_ventas">📅 Mes con Más Ventas</option>
    </select>
</div>

@if (cargando)
{
    <div style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 5px;">
        <p><em>Procesando consulta...</em></p>
    </div>
}

@if (!string.IsNullOrEmpty(resultado))
{
    <div style="margin: 20px 0; padding: 20px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4caf50;">
        <h3>Resultado:</h3>
        <div style="white-space: pre-line;">@((MarkupString)resultado)</div>
    </div>
}

@code {
    private string resultado = "";
    private bool cargando = false;

    private async Task CambiarConsulta(ChangeEventArgs e)
    {
        var consulta = e.Value?.ToString();
        if (string.IsNullOrEmpty(consulta)) return;

        cargando = true;
        resultado = "";
        StateHasChanged();

        await Task.Delay(100);

        try
        {
            resultado = consulta switch
            {
                "total_facturacion" => await TotalFacturacion(),
                "articulo_mas_vendido" => await ArticuloMasVendido(),
                "cliente_mayor_gasto" => await ClienteMayorGasto(),
                "mes_mas_ventas" => await MesMasVentas(),
                _ => "Consulta no implementada"
            };
        }
        catch (Exception ex)
        {
            resultado = $"<span style='color: red;'>Error al procesar la consulta: {ex.Message}</span>";
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task<string> TotalFacturacion()
    {
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .ToListAsync();

        if (!facturas.Any())
            return "No hay facturas registradas.";

        var total = facturas.Sum(f => f.Articulos.Sum(a => a.Precio));
        var cantidad = facturas.Count;
        var promedio = total / cantidad;

        return $"<strong>Facturación total:</strong> ${total:N2}<br/>" +
               $"<strong>Total de facturas:</strong> {cantidad}<br/>" +
               $"<strong>Ticket promedio:</strong> ${promedio:N2}";
    }

    private async Task<string> ArticuloMasVendido()
    {
        var articulos = await DbContext.Articulos
            .GroupBy(a => a.Nombre)
            .Select(g => new { Nombre = g.Key, Cantidad = g.Count() })
            .OrderByDescending(x => x.Cantidad)
            .FirstOrDefaultAsync();

        if (articulos == null)
            return "No hay datos de artículos vendidos.";

        return $"<strong>{articulos.Nombre}</strong><br/>Vendido <strong>{articulos.Cantidad}</strong> veces";
    }

    private async Task<string> ClienteMayorGasto()
    {
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .ToListAsync();

        var cliente = facturas
            .GroupBy(f => f.NombreCliente)
            .Select(g => new
            {
                Cliente = g.Key,
                Total = g.Sum(f => f.Articulos.Sum(a => a.Precio))
            })
            .OrderByDescending(x => x.Total)
            .FirstOrDefault();

        if (cliente == null)
            return "No hay datos de clientes.";

        return $"<strong>{cliente.Cliente}</strong><br/>Gasto total: <strong>${cliente.Total:N2}</strong>";
    }

    private async Task<string> MesMasVentas()
    {
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .ToListAsync();

        var meses = facturas
            .GroupBy(f => new { f.Fecha.Year, f.Fecha.Month })
            .Select(g => new
            {
                Mes = $"{g.Key.Month}/{g.Key.Year}",
                Total = g.Sum(f => f.Articulos.Sum(a => a.Precio)),
                Facturas = g.Count()
            })
            .OrderByDescending(x => x.Total)
            .FirstOrDefault();

        if (meses == null)
            return "No hay datos de ventas.";

        return $"<strong>{meses.Mes}</strong><br/>Facturación: <strong>${meses.Total:N2}</strong><br/>Facturas: {meses.Facturas}";
    }

    private void VolverInicio()
    {
        Navigation.NavigateTo("/");
    }
}