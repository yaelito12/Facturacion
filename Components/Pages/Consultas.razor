@page "/consultas"
@using Facturacion.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject ProtectedSessionStorage SessionStorage
@rendermode InteractiveServer


<div class="m3-container">
    <h1>📊 Consultas Inteligentes</h1>
    <p style="color: var(--md-sys-color-on-surface-variant); font-size: var(--md-sys-typescale-body-large);">
        Explota la información de tu negocio con análisis detallados
    </p>

    <div class="m3-button-group">
        <button class="m3-button m3-button-outlined" @onclick="VolverInicio">← Volver al Inicio</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAFacturas">📋 Ver Facturas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAReportes">📊 Ver Reportes</button>
    </div>

    <div class="m3-card m3-card-elevated">
        <h3>Selecciona una consulta:</h3>
        <div class="m3-text-field">
            <select @bind="consultaSeleccionada" @bind:after="OnConsultaSeleccionadaChanged">
                <option value="">-- Selecciona una consulta --</option>
                <option value="total_facturacion">📈 Resumen General de Facturación</option>
                <option value="articulo_mas_vendido">📦 Artículo Más Vendido</option>
                <option value="cliente_mayor_gasto">👥 Cliente que Más Ha Gastado</option>
                <option value="mes_mas_ventas">📅 Mes con Más Ventas</option>
                <option value="dia_semana_mas_ventas">📅 Día de la Semana con Más Ventas</option>
                <option value="evolucion_mensual">📊 Evolución Mensual de Ventas</option>
                <option value="clientes_inactivos">⚠️ Clientes Inactivos (3+ meses)</option>
                <option value="top_combos">🔗 Productos que se Compran Juntos</option>
            </select>
        </div>
    </div>

    @if (cargando)
    {
        <div class="m3-card" style="text-align: center; padding: 48px;">
            <p style="color: var(--md-sys-color-on-surface-variant);">
                <em>Procesando consulta...</em>
            </p>
        </div>
    }

    @if (!string.IsNullOrEmpty(resultado))
    {
        <div class="m3-card" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container);">
            <h3 style="margin-top: 0; color: inherit;">✨ Resultado:</h3>
            <div style="white-space: pre-line; line-height: 1.8;">
                @((MarkupString)resultado)
            </div>
        </div>
    }
</div>

@code {
    private string consultaSeleccionada = "";
    private string resultado = "";
    private bool cargando = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
            
                var consultaResult = await SessionStorage.GetAsync<string>("consultas_tipo_seleccionado");
                if (consultaResult.Success && !string.IsNullOrEmpty(consultaResult.Value))
                {
                    consultaSeleccionada = consultaResult.Value;
                    await EjecutarConsulta();
                    StateHasChanged();
                }
            }
            catch
            {
             
            }
        }
    }

    private async Task OnConsultaSeleccionadaChanged()
    {
        if (string.IsNullOrEmpty(consultaSeleccionada))
        {
            await SessionStorage.DeleteAsync("consultas_tipo_seleccionado");
            resultado = "";
            return;
        }

        await SessionStorage.SetAsync("consultas_tipo_seleccionado", consultaSeleccionada);
        await EjecutarConsulta();
    }

    private async Task EjecutarConsulta()
    {
        if (string.IsNullOrEmpty(consultaSeleccionada)) return;

        cargando = true;
        resultado = "";
        StateHasChanged();

        await Task.Delay(100);

        try
        {
            resultado = consultaSeleccionada switch
            {
                "total_facturacion" => await TotalFacturacion(),
                "articulo_mas_vendido" => await ArticuloMasVendido(),
                "cliente_mayor_gasto" => await ClienteMayorGasto(),
                "mes_mas_ventas" => await MesMasVentas(),
                "dia_semana_mas_ventas" => await DiaSemanaConMasVentas(),
                "evolucion_mensual" => await EvolucionMensual(),
                "clientes_inactivos" => await ClientesInactivos(),
                "top_combos" => await TopCombos(),
                _ => "Consulta no implementada"
            };
        }
        catch (Exception ex)
        {
            resultado = $"<span style='color: var(--md-sys-color-error);'>Error al procesar la consulta: {ex.Message}</span>";
        }

        cargando = false;
        StateHasChanged();
    }

    private async Task<string> TotalFacturacion()
    {
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada) 
            .ToListAsync();

        if (!facturas.Any())
            return "No hay facturas registradas.";

        var total = facturas.Sum(f => f.Articulos.Sum(a => a.Precio));
        var cantidad = facturas.Count;
        var promedio = total / cantidad;

        return $"<strong>Facturación total:</strong> ${total:N2}<br/>" +
               $"<strong>Total de facturas:</strong> {cantidad}<br/>" +
               $"<strong>Ticket promedio:</strong> ${promedio:N2}";
    }

    private async Task<string> ArticuloMasVendido()
    {
      
        var articulos = await DbContext.Articulos
            .Where(a => !DbContext.Facturas.Any(f => f.Id == a.FacturaId && f.Archivada)) 
            .GroupBy(a => a.Nombre)
            .Select(g => new { Nombre = g.Key, Cantidad = g.Count() })
            .OrderByDescending(x => x.Cantidad)
            .FirstOrDefaultAsync();

        if (articulos == null)
            return "No hay datos de artículos vendidos.";

        return $"<strong>{articulos.Nombre}</strong><br/>Vendido <strong>{articulos.Cantidad}</strong> veces";
    }

    private async Task<string> ClienteMayorGasto()
    {
    
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada) 
            .ToListAsync();

        var cliente = facturas
            .GroupBy(f => f.NombreCliente)
            .Select(g => new
            {
                Cliente = g.Key,
                Total = g.Sum(f => f.Articulos.Sum(a => a.Precio))
            })
            .OrderByDescending(x => x.Total)
            .FirstOrDefault();

        if (cliente == null)
            return "No hay datos de clientes.";

        return $"<strong>{cliente.Cliente}</strong><br/>Gasto total: <strong>${cliente.Total:N2}</strong>";
    }

    private async Task<string> MesMasVentas()
    {
   
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada) 
            .ToListAsync();

        var meses = facturas
            .GroupBy(f => new { f.Fecha.Year, f.Fecha.Month })
            .Select(g => new
            {
                Mes = $"{g.Key.Month}/{g.Key.Year}",
                Total = g.Sum(f => f.Articulos.Sum(a => a.Precio)),
                Facturas = g.Count()
            })
            .OrderByDescending(x => x.Total)
            .FirstOrDefault();

        if (meses == null)
            return "No hay datos de ventas.";

        return $"<strong>{meses.Mes}</strong><br/>Facturación: <strong>${meses.Total:N2}</strong><br/>Facturas: {meses.Facturas}";
    }

    private async Task<string> DiaSemanaConMasVentas()
    {
      
        var facturas = await DbContext.Facturas
            .Where(f => !f.Archivada) 
            .ToListAsync();

        var dias = facturas
            .GroupBy(f => f.Fecha.DayOfWeek)
            .Select(g => new
            {
                Dia = g.Key,
                Cantidad = g.Count()
            })
            .OrderByDescending(x => x.Cantidad)
            .ToList();

        if (!dias.Any())
            return "No hay datos disponibles.";

        var diasEspanol = new Dictionary<DayOfWeek, string>
        {
            { DayOfWeek.Monday, "Lunes" },
            { DayOfWeek.Tuesday, "Martes" },
            { DayOfWeek.Wednesday, "Miércoles" },
            { DayOfWeek.Thursday, "Jueves" },
            { DayOfWeek.Friday, "Viernes" },
            { DayOfWeek.Saturday, "Sábado" },
            { DayOfWeek.Sunday, "Domingo" }
        };

        var html = "<strong>Distribución de ventas por día:</strong><br/><br/>";
        foreach (var dia in dias)
        {
            html += $"• {diasEspanol[dia.Dia]}: <strong>{dia.Cantidad}</strong> facturas<br/>";
        }
        return html;
    }

    private async Task<string> EvolucionMensual()
    {
     
        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada) 
            .ToListAsync();

        var meses = facturas
            .GroupBy(f => new { f.Fecha.Year, f.Fecha.Month })
            .Select(g => new
            {
                Mes = $"{g.Key.Month:00}/{g.Key.Year}",
                Total = g.Sum(f => f.Articulos.Sum(a => a.Precio)),
                Facturas = g.Count()
            })
            .OrderBy(x => x.Mes)
            .ToList();

        if (!meses.Any())
            return "No hay datos disponibles.";

        var html = "<strong>Evolución mensual de facturación:</strong><br/><br/>";
        foreach (var mes in meses)
        {
            html += $"• {mes.Mes}: <strong>${mes.Total:N2}</strong> ({mes.Facturas} facturas)<br/>";
        }
        return html;
    }

    private async Task<string> ClientesInactivos()
    {
        
        var fechaLimite = DateTime.Now.AddMonths(-3);
        var clientes = await DbContext.Facturas
            .Where(f => !f.Archivada) 
            .GroupBy(f => f.NombreCliente)
            .Select(g => new
            {
                Cliente = g.Key,
                UltimaCompra = g.Max(f => f.Fecha)
            })
            .Where(x => x.UltimaCompra < fechaLimite)
            .OrderBy(x => x.UltimaCompra)
            .ToListAsync();

        if (!clientes.Any())
            return "¡Excelente! No hay clientes inactivos.";

        var html = $"<strong>Clientes sin compras desde hace 3+ meses:</strong> ({clientes.Count})<br/><br/>";
        foreach (var cliente in clientes)
        {
            var diasInactivo = (DateTime.Now - cliente.UltimaCompra).Days;
            html += $"• {cliente.Cliente} - Última compra: {cliente.UltimaCompra:dd/MM/yyyy} ({diasInactivo} días)<br/>";
        }
        return html;
    }

    private async Task<string> TopCombos()
    {  

        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => !f.Archivada && f.Articulos.Count > 1)
            .ToListAsync();

        if (!facturas.Any())
            return "No hay facturas con múltiples artículos.";

        var combos = new Dictionary<string, int>();

        foreach (var factura in facturas)
        {
            var articulos = factura.Articulos.Select(a => a.Nombre).OrderBy(n => n).ToList();
            for (int i = 0; i < articulos.Count - 1; i++)
            {
                for (int j = i + 1; j < articulos.Count; j++)
                {
                    var combo = $"{articulos[i]} + {articulos[j]}";
                    if (!combos.ContainsKey(combo))
                        combos[combo] = 0;
                    combos[combo]++;
                }
            }
        }

        var topCombos = combos
            .OrderByDescending(x => x.Value)
            .Take(10)
            .ToList();

        if (!topCombos.Any())
            return "No se encontraron combos frecuentes.";

        var html = "<strong>Top 10 combinaciones más frecuentes:</strong><br/><br/>";
        foreach (var combo in topCombos)
        {
            html += $"• {combo.Key}: <strong>{combo.Value}</strong> veces<br/>";
        }
        return html;
    }

    private void VolverInicio()
    {
        Navigation.NavigateTo("/");
    }

    private void IrAFacturas()
    {
        Navigation.NavigateTo("/facturas");
    }

    private void IrAReportes()
    {
        Navigation.NavigateTo("/reportes");
    }
}