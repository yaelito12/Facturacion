@page "/archivadas"
@using Facturacion.Data
@using Facturacion.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject ArchivoService ArchivoService
@inject IJSRuntime JS
@rendermode InteractiveServer



<div class="m3-container">
    @if (!autenticado)
    {
        <div class="m3-card m3-card-elevated" style="max-width: 500px; margin: 48px auto;">
            <h1 style="text-align: center;">🔒 Facturas Archivadas</h1>
            <p style="text-align: center; color: var(--md-sys-color-on-surface-variant); margin: 24px 0;">
                Ingresa la contraseña para acceder a las facturas archivadas
            </p>

            <div class="m3-text-field">
                <label>Contraseña:</label>
                <input type="password"
                       @bind="contraseñaIngresada"
                       @bind:event="oninput"
                       @onkeydown="OnKeyPress"
                       placeholder="Ingresa la contraseña"
                       autofocus />
            </div>

            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="m3-message m3-message-error">
                    @mensajeError
                </div>
            }

            <div class="m3-button-group" style="margin-top: 24px;">
                <button class="m3-button m3-button-filled" @onclick="ValidarContraseña" style="flex: 1;">
                    ✓ Ingresar
                </button>
                <button class="m3-button m3-button-outlined" @onclick="Volver">
                    ← Volver
                </button>
            </div>
        </div>
    }
    else
    {
        <h1>📦 Facturas Archivadas</h1>

        <div class="m3-button-group">
            <button class="m3-button m3-button-outlined" @onclick="Volver">
                ← Volver al Inicio
            </button>
        </div>

        @if (facturas == null)
        {
            <div class="m3-card" style="text-align: center; padding: 48px;">
                <p style="color: var(--md-sys-color-on-surface-variant);">Cargando facturas archivadas...</p>
            </div>
        }
        else if (!facturas.Any())
        {
            <div class="m3-card m3-card-elevated" style="text-align: center; padding: 48px;">
                <h3>No hay facturas archivadas</h3>
                <p style="color: var(--md-sys-color-on-surface-variant); margin: 16px 0;">
                    Las facturas archivadas aparecerán aquí
                </p>
            </div>
        }
        else
        {
            <div class="m3-card m3-card-elevated" style="padding: 0; overflow: hidden;">
                <div style="padding: 24px; background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">
                    <h2 style="margin: 0;">
                        Facturas Archivadas: <span class="m3-chip" style="background-color: var(--md-sys-color-tertiary); color: var(--md-sys-color-on-tertiary);">@facturas.Count</span>
                    </h2>
                </div>

                <table class="m3-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th style="text-align: right;">Total</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var f in facturas)
                        {
                            <tr style="background-color: var(--md-sys-color-surface-container-low);">
                                <td><strong>#@f.Id</strong></td>
                                <td>@f.Fecha.ToString("dd/MM/yyyy")</td>
                                <td>@f.NombreCliente</td>
                                <td style="text-align: right;"><strong>$@f.Total.ToString("F2")</strong></td>
                                <td style="text-align: center;">
                                    <div class="m3-button-group" style="justify-content: center;">
                                        <button class="m3-button m3-button-tonal" @onclick="@(() => VerDetalles(f))">
                                            👁️ Ver Detalles
                                        </button>
                                        <button class="m3-button m3-button-filled" @onclick="@(() => DesarchivarFactura(f.Id))">
                                            📤 Desarchivar
                                        </button>
                                        <button class="m3-button m3-button-error" @onclick="@(() => EliminarFactura(f.Id))">
                                            🗑️ Eliminar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>TOTAL GENERAL</strong></td>
                            <td style="text-align: right;"><strong>$@facturas.Sum(f => f.Total).ToString("F2")</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            @if (facturaSeleccionada != null)
            {
                <div class="m3-card m3-card-elevated">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">Detalle de Factura #@facturaSeleccionada.Id</h3>
                        <button class="m3-button m3-button-outlined" @onclick="CerrarDetalles">
                            ✕ Cerrar
                        </button>
                    </div>

                    <div class="m3-text-field">
                        <label>Cliente:</label>
                        <p style="font-size: 18px; padding: 16px; background-color: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-small); margin: 0;">
                            @facturaSeleccionada.NombreCliente
                        </p>
                    </div>

                    <div class="m3-text-field">
                        <label>Fecha:</label>
                        <p style="font-size: 18px; padding: 16px; background-color: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-small); margin: 0;">
                            @facturaSeleccionada.Fecha.ToString("dd/MM/yyyy")
                        </p>
                    </div>

                    <h4>Artículos:</h4>
                    <table class="m3-table">
                        <thead>
                            <tr>
                                <th>Artículo</th>
                                <th style="text-align: right;">Precio</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var art in facturaSeleccionada.Articulos)
                            {
                                <tr>
                                    <td>@art.Nombre</td>
                                    <td style="text-align: right;"><strong>$@art.Precio.ToString("F2")</strong></td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL</strong></td>
                                <td style="text-align: right;"><strong>$@facturaSeleccionada.Total.ToString("F2")</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
        }
    }
</div>

@code {
    private bool autenticado = false;
    private string contraseñaIngresada = "";
    private string mensajeError = "";
    private List<Factura>? facturas;
    private Factura? facturaSeleccionada;

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
          
            await Task.Delay(10);
            await ValidarContraseña();
        }
    }

    private async Task ValidarContraseña()
    {
        mensajeError = "";

        if (string.IsNullOrWhiteSpace(contraseñaIngresada))
        {
            mensajeError = "Por favor ingresa la contraseña";
            return;
        }

        if (ArchivoService.ValidarContraseña(contraseñaIngresada))
        {
            autenticado = true;
            await CargarFacturas();
        }
        else
        {
            mensajeError = "Contraseña incorrecta";
            contraseñaIngresada = "";
        }
    }

    private async Task CargarFacturas()
    {
        facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => f.Archivada)
            .OrderByDescending(f => f.Fecha)
            .ToListAsync();
    }

    private void VerDetalles(Factura factura)
    {
        facturaSeleccionada = factura;
    }

    private void CerrarDetalles()
    {
        facturaSeleccionada = null;
    }

    private async Task DesarchivarFactura(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm",
            $"¿Deseas desarchivar la factura #{id}? Volverá a aparecer en reportes y consultas.");

        if (!confirmar)
            return;

        var factura = await DbContext.Facturas.FindAsync(id);
        if (factura != null)
        {
            factura.Archivada = false;
            await DbContext.SaveChangesAsync();
            await CargarFacturas();
        }
    }

    private async Task EliminarFactura(int id)
    {
        bool confirmar = await JS.InvokeAsync<bool>("confirm",
            $"¿Estás seguro de que deseas eliminar permanentemente la factura #{id}?");

        if (!confirmar)
            return;

        var factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == id);

        if (factura != null)
        {
            DbContext.Facturas.Remove(factura);
            await DbContext.SaveChangesAsync();
            await CargarFacturas();
        }
    }

    private void Volver()
    {
        Navigation.NavigateTo("/");
    }
}