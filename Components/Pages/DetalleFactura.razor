@page "/factura/{Id:int}"
@using Facturacion.Data
@using Facturacion.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject FacturaNavigationService NavService
@rendermode InteractiveServer
@implements IDisposable



<div class="m3-container">
    @if (cargando)
    {
        <div class="m3-card" style="text-align: center; padding: 48px;">
            <p style="color: var(--md-sys-color-on-surface-variant);">Verificando acceso...</p>
        </div>
    }
    else if (accesoNoAutorizado)
    {
        <div class="m3-card m3-card-elevated" style="text-align: center; padding: 48px; border: 2px solid var(--md-sys-color-error);">
            <h2 style="color: var(--md-sys-color-error);">Acceso No Autorizado</h2>
            <p style="color: var(--md-sys-color-on-surface-variant); margin: 16px 0;">
                No tienes permisos para acceder a esta factura directamente.
            </p>
            <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 24px;">
                Por favor, accede desde la lista de facturas.
            </p>
            <button class="m3-button m3-button-filled" @onclick="IrAFacturas">
                Ir a Lista de Facturas
            </button>
        </div>
    }
    else if (factura == null)
    {
        <div class="m3-card m3-card-elevated" style="text-align: center; padding: 48px;">
            <h2>Factura no encontrada</h2>
            <button class="m3-button m3-button-filled" @onclick="IrAFacturas" style="margin-top: 24px;">
                ← Volver a Facturas
            </button>
        </div>
    }
    else
    {
        <h1>Detalle de Factura</h1>

        <div class="m3-button-group">
            <button class="m3-button m3-button-outlined" @onclick="IrAFacturas">
                ← Volver a Facturas
            </button>
            <button class="m3-button m3-button-outlined" @onclick="IrAHome">
                Ir a Nueva Factura
            </button>
            @if (!modoEdicion)
            {
                <button class="m3-button m3-button-filled" @onclick="HabilitarEdicion">
                    Editar Factura
                </button>
            }
        </div>

        <div class="m3-card m3-card-elevated">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin: 0;">Factura #@factura.Id</h2>
                @if (modoEdicion)
                {
                    <span class="m3-chip" style="background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-tertiary-container);">
                        Modo Edición
                    </span>
                }
            </div>

            <div class="m3-text-field">
                <label>Cliente:</label>
                @if (modoEdicion)
                {
                    <input type="text" value="@factura.NombreCliente"
                           @oninput="@(async (e) => { factura.NombreCliente = e.Value?.ToString() ?? ""; ValidarCliente(); await VerificarYHabilitarInterceptor(); })"
                           placeholder="Nombre del cliente (mínimo 3 caracteres)" />
                    @if (mostrarErrorCliente)
                    {
                        <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                            ⚠️ El nombre del cliente debe tener al menos 3 caracteres
                        </small>
                    }
                }
                else
                {
                    <p style="font-size: 18px; padding: 16px; background-color: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-small); margin: 0;">
                        @factura.NombreCliente
                    </p>
                }
            </div>

            <div class="m3-text-field">
                <label>Fecha:</label>
                @if (modoEdicion)
                {
                    <input type="date" value="@factura.Fecha.ToString("yyyy-MM-dd")"
                           @onchange="@(async (e) => { if (DateTime.TryParse(e.Value?.ToString(), out var fecha)) { factura.Fecha = fecha; await VerificarYHabilitarInterceptor(); } })" />
                }
                else
                {
                    <p style="font-size: 18px; padding: 16px; background-color: var(--md-sys-color-surface-container-high); border-radius: var(--md-sys-shape-corner-small); margin: 0;">
                        @factura.Fecha.ToString("dd/MM/yyyy")
                    </p>
                }
            </div>

            <hr class="m3-divider" />

            <h3>Artículos</h3>

            @if (factura.Articulos != null && factura.Articulos.Any())
            {
                <div style="padding: 0; overflow: hidden;">
                    <table class="m3-table">
                        <thead>
                            <tr>
                                <th>Artículo</th>
                                <th style="text-align: right;">Precio</th>
                                @if (modoEdicion)
                                {
                                    <th style="text-align: center;">Acciones</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var art in factura.Articulos)
                            {
                                <tr>
                                    <td>
                                        @if (modoEdicion)
                                        {
                                            <input type="text" value="@art.Nombre"
                                                   @oninput="@(async (e) => { art.Nombre = e.Value?.ToString() ?? ""; ValidarArticulo(art); await VerificarYHabilitarInterceptor(); })"
                                                   placeholder="Nombre del artículo (mínimo 2 caracteres)"
                                                   style="width: 100%;" />
                                            @if (articulosConError.Contains(art))
                                            {
                                                <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                                                    ⚠️ Mínimo 2 caracteres
                                                </small>
                                            }
                                        }
                                        else
                                        {
                                            @art.Nombre
                                        }
                                    </td>
                                    <td style="text-align: right;">
                                        @if (modoEdicion)
                                        {
                                            <input type="text"
                                                   value="@(preciosTemporales.ContainsKey(art) ? preciosTemporales[art] : art.Precio.ToString("0.##"))"
                                                   @oninput="@(async (e) => {
                                                   var valor = e.Value?.ToString() ?? "";

                                              
                                                   preciosTemporales[art] = valor;

                                                
                                                   if (System.Text.RegularExpressions.Regex.IsMatch(valor, @"[^\d.]"))
                                                   {
                                                       articulosConFormatoInvalido[art] = "Solo se permiten números y punto decimal";
                                                       StateHasChanged();
                                                       return;
                                                   }

                                                  
                                                   if (valor.Count(c => c == '.') > 1)
                                                   {
                                                       articulosConFormatoInvalido[art] = "Solo se permite un punto decimal";
                                                       StateHasChanged();
                                                       return;
                                                   }

                                                  
                                                   articulosConFormatoInvalido.Remove(art);

                                                   if (string.IsNullOrWhiteSpace(valor))
                                                   {
                                                       art.Precio = 0;
                                                       articulosConPrecioNegativo.Remove(art);
                                                       await VerificarYHabilitarInterceptor();
                                                       StateHasChanged();
                                                       return;
                                                   }

                                                   if (decimal.TryParse(valor, System.Globalization.NumberStyles.AllowDecimalPoint,
                                                       System.Globalization.CultureInfo.InvariantCulture, out var precio))
                                                   {
                                                       if (precio < 0)
                                                       {
                                                           articulosConPrecioNegativo.Add(art);
                                                       }
                                                       else
                                                       {
                                                           articulosConPrecioNegativo.Remove(art);
                                                       }
                                                       art.Precio = precio;
                                                       await VerificarYHabilitarInterceptor();
                                                   }
                                                   StateHasChanged();
                                               })"
                                                 placeholder="0.00"
                                                 style="width: 120px; text-align: right;" />
                                        @if (articulosConFormatoInvalido.ContainsKey(art))
                                        {
                                            <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                                                ⚠️ @articulosConFormatoInvalido[art]
                                            </small>
                                        }
                                        else if (articulosConPrecioNegativo.Contains(art))
                                        {
                                            <small style="color: var(--md-sys-color-error); display: block; margin-top: 4px;">
                                                ⚠️ El precio no puede ser negativo
                                            </small>
                                        }
                                    }
                                                        else
                                    {
                                        <strong>$@art.Precio.ToString("F2")</strong>
                                    }
                                </td>
                                @if (modoEdicion)
                                {
                                    <td style="text-align: center;">
                                        <button class="m3-button m3-button-text" style="color: var(--md-sys-color-error);" @onclick="() => EliminarArticulo(art)">
                                            Eliminar
                                        </button>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><strong>TOTAL</strong></td>
                            <td style="text-align: right;"><strong>$@factura.Total.ToString("F2")</strong></td>
                            @if (modoEdicion)
                            {
                                <td></td>
                            }
                        </tr>
                    </tfoot>
                </table>
            </div>

            @if (modoEdicion)
            {
                <button class="m3-button m3-button-tonal" @onclick="AgregarArticulo" style="margin-top: 16px;">
                    Agregar Artículo
                </button>
            }
        }
                else
        {
            <p style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 24px;">
                No hay artículos en esta factura.
            </p>
        }

        @if (modoEdicion)
        {
            <hr class="m3-divider" />
            <div class="m3-button-group">
                <button class="m3-button m3-button-filled" @onclick="GuardarCambios">
                    Guardar Cambios
                </button>
                <button class="m3-button m3-button-outlined" @onclick="CancelarEdicion">
                    Cancelar
                </button>
            </div>
        }

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <div class="@(mensaje.Contains("exitosamente") ? "m3-message m3-message-success" : "m3-message m3-message-error")">
                @mensaje
            </div>
        }
    </div>
        }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private Factura? factura;
    private Factura? facturaOriginal;
    private bool modoEdicion = false;
    private string mensaje = "";
    private bool navegacionConfirmada = false;
    private bool accesoNoAutorizado = false;
    private bool cargando = true;

    private bool mostrarErrorCliente = false;
    private HashSet<Articulo> articulosConError = new();
    private HashSet<Articulo> articulosConPrecioNegativo = new();
    private Dictionary<Articulo, string> articulosConFormatoInvalido = new();
    private Dictionary<Articulo, string> preciosTemporales = new();

    private const int LONGITUD_MINIMA_CLIENTE = 3;
    private const int LONGITUD_MINIMA_ARTICULO = 2;

    protected override async Task OnInitializedAsync()
    {
        var accesoAutorizado = await NavService.ValidarYAutorizarAsync(Id, Token);

        if (!accesoAutorizado)
        {
            accesoNoAutorizado = true;
            cargando = false;
            return;
        }

        await CargarFactura();
        Navigation.LocationChanged += OnLocationChanged;
        cargando = false;
    }

    private async Task CargarFactura()
    {
        factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .AsNoTracking()
            .FirstOrDefaultAsync(f => f.Id == Id);
    }

    private async void HabilitarEdicion()
    {
        GuardarEstadoOriginal();
        modoEdicion = true;
        mensaje = "";
        mostrarErrorCliente = false;
        articulosConError.Clear();
        articulosConPrecioNegativo.Clear();
        articulosConFormatoInvalido.Clear();
        preciosTemporales.Clear();
        StateHasChanged();
    }

    private void GuardarEstadoOriginal()
    {
        if (factura != null)
        {
            facturaOriginal = new Factura
            {
                Id = factura.Id,
                NombreCliente = factura.NombreCliente,
                Fecha = factura.Fecha,
                Articulos = factura.Articulos.Select(a => new Articulo
                {
                    Id = a.Id,
                    Nombre = a.Nombre,
                    Precio = a.Precio,
                    FacturaId = a.FacturaId
                }).ToList()
            };
        }
    }

    private void ValidarCliente()
    {
        if (factura == null) return;
        var nombre = factura.NombreCliente ?? "";
        mostrarErrorCliente = !string.IsNullOrWhiteSpace(nombre) && nombre.Trim().Length < LONGITUD_MINIMA_CLIENTE;
    }

    private void ValidarArticulo(Articulo art)
    {
        var nombre = art.Nombre ?? "";
        if (!string.IsNullOrWhiteSpace(nombre) && nombre.Trim().Length < LONGITUD_MINIMA_ARTICULO)
        {
            articulosConError.Add(art);
        }
        else
        {
            articulosConError.Remove(art);
        }
    }

    private void ValidarPrecio(Articulo art)
    {
        if (art.Precio < 0)
        {
            articulosConPrecioNegativo.Add(art);
        }
        else
        {
            articulosConPrecioNegativo.Remove(art);
        }
    }

    private bool TieneCambios()
    {
        if (!modoEdicion || factura == null || facturaOriginal == null)
            return false;

        if (factura.NombreCliente != facturaOriginal.NombreCliente)
            return true;

        if (factura.Fecha != facturaOriginal.Fecha)
            return true;

        if (factura.Articulos.Count != facturaOriginal.Articulos.Count)
            return true;

        foreach (var artActual in factura.Articulos)
        {
            var artOriginal = facturaOriginal.Articulos.FirstOrDefault(a => a.Id == artActual.Id);

            if (artActual.Id == 0 || artOriginal == null)
                return true;

            if (artActual.Nombre != artOriginal.Nombre || artActual.Precio != artOriginal.Precio)
                return true;
        }

        return false;
    }

    private async void CancelarEdicion()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas descartar los cambios?");

            if (!confirmar)
                return;
        }

        await FinalizarCancelacion();
    }

    private async Task FinalizarCancelacion()
    {
        modoEdicion = false;
        mensaje = "";
        mostrarErrorCliente = false;
        articulosConError.Clear();
        articulosConPrecioNegativo.Clear();
        articulosConFormatoInvalido.Clear();
        preciosTemporales.Clear();
        await DeshabilitarInterceptorNavegacion();
        await CargarFactura();
        StateHasChanged();
    }

    private async Task GuardarCambios()
    {
        mensaje = "";

       
        if (articulosConFormatoInvalido.Any())
        {
            mensaje = "Hay artículos con formato de precio inválido. Solo se permiten números y punto decimal.";
            StateHasChanged();
            return;
        }

       
        mostrarErrorCliente = false;
        articulosConError.Clear();
        articulosConPrecioNegativo.Clear();

     
        if (string.IsNullOrWhiteSpace(factura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            mostrarErrorCliente = true;
            return;
        }

        if (factura.NombreCliente.Trim().Length < LONGITUD_MINIMA_CLIENTE)
        {
            mensaje = $"El nombre del cliente debe tener al menos {LONGITUD_MINIMA_CLIENTE} caracteres";
            mostrarErrorCliente = true;
            return;
        }

        
        var articulosValidos = new List<Articulo>();
        var hayErroresArticulos = false;
        var hayPreciosNegativos = false;

        foreach (var art in factura.Articulos)
        {
           
            if (art.Precio < 0)
            {
                articulosConPrecioNegativo.Add(art);
                hayPreciosNegativos = true;
                continue;
            }

            if (string.IsNullOrWhiteSpace(art.Nombre))
                continue;

            if (art.Nombre.Trim().Length < LONGITUD_MINIMA_ARTICULO)
            {
                articulosConError.Add(art);
                hayErroresArticulos = true;
                continue;
            }

            if (art.Precio > 0)
            {
                articulosValidos.Add(art);
            }
        }

        if (hayPreciosNegativos)
        {
            mensaje = "Los precios no pueden ser negativos";
            return;
        }

        if (hayErroresArticulos)
        {
            mensaje = $"Los nombres de artículos deben tener al menos {LONGITUD_MINIMA_ARTICULO} caracteres";
            return;
        }

        if (!articulosValidos.Any())
        {
            mensaje = "Debe haber al menos un artículo válido con nombre y precio";
            return;
        }

        factura.Articulos = articulosValidos;

        var facturaDb = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == Id);

        if (facturaDb != null)
        {
            facturaDb.NombreCliente = factura.NombreCliente.Trim();
            facturaDb.Fecha = factura.Fecha;

            DbContext.Articulos.RemoveRange(facturaDb.Articulos);
            facturaDb.Articulos = factura.Articulos.Select(a => new Articulo
            {
                Nombre = a.Nombre.Trim(),
                Precio = a.Precio,
                FacturaId = factura.Id
            }).ToList();

            await DbContext.SaveChangesAsync();
        }

        mensaje = "Factura actualizada exitosamente";
        modoEdicion = false;
        await CargarFactura();
        await DeshabilitarInterceptorNavegacion();
    }

    private void AgregarArticulo()
    {
        factura!.Articulos.Add(new Articulo { FacturaId = factura.Id });
        _ = VerificarYHabilitarInterceptor();
    }

    private void EliminarArticulo(Articulo art)
    {
        if (factura!.Articulos.Count > 1)
        {
            factura.Articulos.Remove(art);
            articulosConError.Remove(art);
            articulosConPrecioNegativo.Remove(art);
            articulosConFormatoInvalido.Remove(art);
            preciosTemporales.Remove(art);
            _ = VerificarYHabilitarInterceptor();
        }
        else
        {
            mensaje = "Debe haber al menos un artículo";
        }
    }

    private async void IrAFacturas()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        NavService.RevocarAutorizacion(Id);
        Navigation.NavigateTo("/facturas");
    }

    private async void IrAHome()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        NavService.RevocarAutorizacion(Id);
        Navigation.NavigateTo("/");
    }

    private bool procesandoNavegacion = false;

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (procesandoNavegacion || e.Location.Contains($"/factura/{Id}"))
            return;

        if (modoEdicion && TieneCambios() && !navegacionConfirmada)
        {
            procesandoNavegacion = true;
            Navigation.NavigateTo($"/factura/{Id}", false);

            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (confirmar)
            {
                navegacionConfirmada = true;
                await DeshabilitarInterceptorNavegacion();
                NavService.RevocarAutorizacion(Id);
                Navigation.NavigateTo(e.Location);
            }

            procesandoNavegacion = false;
        }
    }

    private async Task HabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = false;
        await JS.InvokeVoidAsync("eval", @"
            window.beforeUnloadHandler = function(e) {
                e.preventDefault();
                e.returnValue = 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
                return 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
            };
            window.addEventListener('beforeunload', window.beforeUnloadHandler);
        ");
    }

    private async Task VerificarYHabilitarInterceptor()
    {
        if (TieneCambios())
        {
            await HabilitarInterceptorNavegacion();
        }
        else
        {
            await DeshabilitarInterceptorNavegacion();
        }
    }

    private async Task DeshabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = true;
        await JS.InvokeVoidAsync("eval", @"
            if (window.beforeUnloadHandler) {
                window.removeEventListener('beforeunload', window.beforeUnloadHandler);
                window.beforeUnloadHandler = null;
            }
        ");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        _ = DeshabilitarInterceptorNavegacion();

        if (!accesoNoAutorizado)
        {
            NavService.RevocarAutorizacion(Id);
        }
    }
}