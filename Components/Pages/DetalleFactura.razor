@page "/factura/{Id:int}"
@using Facturacion.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@rendermode InteractiveServer
@implements IDisposable

<h1>Detalle de Factura</h1>

<div style="margin-bottom: 20px;">
    <button @onclick="IrAFacturas">← Volver a Facturas</button>
    <button @onclick="IrAHome">Ir a Nueva Factura</button>
    <button @onclick="HabilitarEdicion">Editar Factura</button>
</div>

@if (factura == null)
{
    <p>Cargando detalle...</p>
}
else
{
    <div style="border: 2px solid black; padding: 20px;">
        <h2>Factura #@factura.Id</h2>

        <div>
            <p><strong>Cliente:</strong></p>
            @if (modoEdicion)
            {
                <input type="text" value="@factura.NombreCliente"
                       @oninput="@(async (e) => { factura.NombreCliente = e.Value?.ToString() ?? ""; await VerificarYHabilitarInterceptor(); })"
                       style="width: 300px;" />
            }
            else
            {
                <p>@factura.NombreCliente</p>
            }

            <p><strong>Fecha:</strong></p>
            @if (modoEdicion)
            {
                <input type="date" value="@factura.Fecha.ToString("yyyy-MM-dd")"
                       @onchange="@(async (e) => { if (DateTime.TryParse(e.Value?.ToString(), out var fecha)) { factura.Fecha = fecha; await VerificarYHabilitarInterceptor(); } })" />
            }
            else
            {
                <p>@factura.Fecha.ToShortDateString()</p>
            }
        </div>

        <h3>Artículos:</h3>

        @if (factura.Articulos != null && factura.Articulos.Any())
        {
            <table border="1" cellpadding="10" cellspacing="0">
                <thead>
                    <tr>
                        <th>Artículo</th>
                        <th>Precio</th>
                        @if (modoEdicion)
                        {
                            <th>Acciones</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var art in factura.Articulos)
                    {
                        <tr>
                            <td>
                                @if (modoEdicion)
                                {
                                    <input type="text" value="@art.Nombre"
                                           @oninput="@(async (e) => { art.Nombre = e.Value?.ToString() ?? ""; await VerificarYHabilitarInterceptor(); })"
                                           style="width: 200px;" />
                                }
                                else
                                {
                                    @art.Nombre
                                }
                            </td>
                            <td>
                                @if (modoEdicion)
                                {
                                    <input type="number" step="0.01" value="@art.Precio"
                                           @oninput="@(async (e) => { if (decimal.TryParse(e.Value?.ToString(), out var precio)) { art.Precio = precio; await VerificarYHabilitarInterceptor(); } })"
                                           style="width: 100px;" />
                                }
                                else
                                {
                                    <text>$@art.Precio.ToString("F2")</text>
                                }
                            </td>
                            @if (modoEdicion)
                            {
                                <td>
                                    <button @onclick="() => EliminarArticulo(art)">Eliminar</button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

            @if (modoEdicion)
            {
                <button @onclick="AgregarArticulo" style="margin-top: 10px;">Agregar Artículo</button>
            }
        }
        else
        {
            <p>No hay artículos en esta factura.</p>
        }

        <div style="margin-top: 30px;">
            <h3>Total: $@factura.Total.ToString("F2")</h3>
        </div>

        @if (modoEdicion)
        {
            <div style="margin-top: 20px;">
                <button @onclick="GuardarCambios">Guardar Cambios</button>
                <button @onclick="CancelarEdicion">Cancelar</button>
            </div>
        }

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <p>@mensaje</p>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Factura? factura;
    private Factura? facturaOriginal; // Copia del estado original
    private bool modoEdicion = false;
    private string mensaje = "";
    private bool navegacionConfirmada = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarFactura();
        Navigation.LocationChanged += OnLocationChanged;
    }

    private async Task CargarFactura()
    {
        factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .AsNoTracking()
            .FirstOrDefaultAsync(f => f.Id == Id);
    }

    private async void HabilitarEdicion()
    {
        GuardarEstadoOriginal(); // Guardar ANTES de habilitar modo edición
        modoEdicion = true;
        mensaje = "";
        StateHasChanged(); // Forzar actualización de UI

        // NO habilitar interceptor aquí, se habilitará cuando haya cambios
    }

    private void GuardarEstadoOriginal()
    {
        if (factura != null)
        {
            facturaOriginal = new Factura
            {
                Id = factura.Id,
                NombreCliente = factura.NombreCliente,
                Fecha = factura.Fecha,
                Articulos = factura.Articulos.Select(a => new Articulo
                {
                    Id = a.Id,
                    Nombre = a.Nombre,
                    Precio = a.Precio,
                    FacturaId = a.FacturaId
                }).ToList()
            };
        }
    }

    private bool TieneCambios()
    {
        // Si no estamos en modo edición o no hay datos, no hay cambios
        if (!modoEdicion || factura == null)
            return false;

        // Si no se guardó el estado original, no podemos comparar (asumimos sin cambios)
        if (facturaOriginal == null)
            return false;

        // Comparar cliente
        if (factura.NombreCliente != facturaOriginal.NombreCliente)
            return true;

        // Comparar fecha
        if (factura.Fecha != facturaOriginal.Fecha)
            return true;

        // Comparar cantidad de artículos
        if (factura.Articulos.Count != facturaOriginal.Articulos.Count)
            return true;

        // Comparar cada artículo
        foreach (var artActual in factura.Articulos)
        {
            var artOriginal = facturaOriginal.Articulos.FirstOrDefault(a => a.Id == artActual.Id);

            // Si es un artículo nuevo (Id = 0 o no existe en original)
            if (artActual.Id == 0 || artOriginal == null)
                return true;

            // Comparar nombre y precio
            if (artActual.Nombre != artOriginal.Nombre || artActual.Precio != artOriginal.Precio)
                return true;
        }

        return false;
    }

    private async void CancelarEdicion()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas descartar los cambios?");

            if (!confirmar)
                return;
        }

        await FinalizarCancelacion();
    }

    private async Task FinalizarCancelacion()
    {
        modoEdicion = false;
        mensaje = "";
        await DeshabilitarInterceptorNavegacion();
        await CargarFactura();
        StateHasChanged();
    }

    private async Task GuardarCambios()
    {
        mensaje = "";

        if (string.IsNullOrWhiteSpace(factura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            return;
        }

        var articulosValidos = factura.Articulos.Where(a =>
            !string.IsNullOrWhiteSpace(a.Nombre) && a.Precio > 0).ToList();

        if (!articulosValidos.Any())
        {
            mensaje = "Debe haber al menos un artículo válido";
            return;
        }

        factura.Articulos = articulosValidos;

        var facturaDb = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == Id);

        if (facturaDb != null)
        {
            facturaDb.NombreCliente = factura.NombreCliente;
            facturaDb.Fecha = factura.Fecha;

            DbContext.Articulos.RemoveRange(facturaDb.Articulos);
            facturaDb.Articulos = factura.Articulos.Select(a => new Articulo
            {
                Nombre = a.Nombre,
                Precio = a.Precio,
                FacturaId = factura.Id
            }).ToList();

            await DbContext.SaveChangesAsync();
        }

        mensaje = "Factura actualizada exitosamente";
        modoEdicion = false;
        await CargarFactura();
        await DeshabilitarInterceptorNavegacion();
    }

    private void AgregarArticulo()
    {
        factura!.Articulos.Add(new Articulo { FacturaId = factura.Id });
        _ = VerificarYHabilitarInterceptor();
    }

    private void EliminarArticulo(Articulo art)
    {
        if (factura!.Articulos.Count > 1)
        {
            factura.Articulos.Remove(art);
            _ = VerificarYHabilitarInterceptor();
        }
        else
        {
            mensaje = "Debe haber al menos un artículo";
        }
    }

    private async void IrAFacturas()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        Navigation.NavigateTo("/facturas");
    }

    private async void IrAHome()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        Navigation.NavigateTo("/");
    }

    private bool procesandoNavegacion = false;

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        // Si ya estamos procesando una navegación, ignorar
        if (procesandoNavegacion)
            return;

        // Solo interceptar si no es la URL actual
        if (e.Location.Contains($"/factura/{Id}"))
            return;

        if (modoEdicion && TieneCambios() && !navegacionConfirmada)
        {
            procesandoNavegacion = true;

            // Prevenir la navegación
            Navigation.NavigateTo($"/factura/{Id}", false);

            // Mostrar confirmación del navegador
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (confirmar)
            {
                navegacionConfirmada = true;
                await DeshabilitarInterceptorNavegacion();
                Navigation.NavigateTo(e.Location);
            }

            procesandoNavegacion = false;
        }
    }

    private async Task HabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = false;
        await JS.InvokeVoidAsync("eval", @"
            window.beforeUnloadHandler = function(e) {
                e.preventDefault();
                e.returnValue = 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
                return 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
            };
            window.addEventListener('beforeunload', window.beforeUnloadHandler);
        ");
    }

    private async Task VerificarYHabilitarInterceptor()
    {
        if (TieneCambios())
        {
            await HabilitarInterceptorNavegacion();
        }
        else
        {
            await DeshabilitarInterceptorNavegacion();
        }
    }

    private async Task DeshabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = true;
        await JS.InvokeVoidAsync("eval", @"
            if (window.beforeUnloadHandler) {
                window.removeEventListener('beforeunload', window.beforeUnloadHandler);
                window.beforeUnloadHandler = null;
            }
        ");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        _ = DeshabilitarInterceptorNavegacion();
    }
}