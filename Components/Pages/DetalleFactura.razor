@page "/factura/{Id:int}"
@using Facturacion.Data
@using Facturacion.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject FacturaNavigationService NavService
@rendermode InteractiveServer
@implements IDisposable

<h1>Detalle de Factura</h1>

@if (cargando)
{
    <p>Verificando acceso...</p>
}
else if (accesoNoAutorizado)
{
    <div style="border: 2px solid red; padding: 20px; background-color: #ffe6e6;">
        <h2>⚠️ Acceso No Autorizado</h2>
        <p>No tienes permisos para acceder a esta factura directamente.</p>
        <p>Por favor, accede desde la lista de facturas.</p>
        <button @onclick="IrAFacturas">Ir a Lista de Facturas</button>
    </div>
}
else if (factura == null)
{
    <p>Factura no encontrada</p>
    <button @onclick="IrAFacturas">← Volver a Facturas</button>
}
else
{
    <div style="margin-bottom: 20px;">
        <button @onclick="IrAFacturas">← Volver a Facturas</button>
        <button @onclick="IrAHome">Ir a Nueva Factura</button>
        <button @onclick="HabilitarEdicion">Editar Factura</button>
    </div>

    <div style="border: 2px solid black; padding: 20px;">
        <h2>Factura #@factura.Id</h2>

        <div>
            <p><strong>Cliente:</strong></p>
            @if (modoEdicion)
            {
                <input type="text" @bind="factura.NombreCliente" @bind:event="oninput" style="width: 300px;" />
            }
            else
            {
                <p>@factura.NombreCliente</p>
            }

            <p><strong>Fecha:</strong></p>
            @if (modoEdicion)
            {
                <input type="date" @bind="factura.Fecha" @bind:event="oninput" />
            }
            else
            {
                <p>@factura.Fecha.ToShortDateString()</p>
            }
        </div>

        <h3>Artículos:</h3>

        @if (factura.Articulos != null && factura.Articulos.Any())
        {
            <table border="1" cellpadding="10" cellspacing="0">
                <thead>
                    <tr>
                        <th>Artículo</th>
                        <th>Precio</th>
                        @if (modoEdicion)
                        {
                            <th>Acciones</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var art in factura.Articulos)
                    {
                        <tr>
                            <td>
                                @if (modoEdicion)
                                {
                                    <input type="text" @bind="art.Nombre" @bind:event="oninput" style="width: 200px;" />
                                }
                                else
                                {
                                    @art.Nombre
                                }
                            </td>
                            <td>
                                @if (modoEdicion)
                                {
                                    <input type="number" step="0.01" @bind="art.Precio" @bind:event="oninput" style="width: 100px;" />
                                }
                                else
                                {
                                    <text>$@art.Precio.ToString("F2")</text>
                                }
                            </td>
                            @if (modoEdicion)
                            {
                                <td>
                                    <button @onclick="() => EliminarArticulo(art)">Eliminar</button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

            @if (modoEdicion)
            {
                <button @onclick="AgregarArticulo" style="margin-top: 10px;">Agregar Artículo</button>
            }
        }
        else
        {
            <p>No hay artículos en esta factura.</p>
        }

        <div style="margin-top: 30px;">
            <h3>Total: $@factura.Total.ToString("F2")</h3>
        </div>

        @if (modoEdicion)
        {
            <div style="margin-top: 20px;">
                <button @onclick="GuardarCambios">Guardar Cambios</button>
                <button @onclick="CancelarEdicion">Cancelar</button>
            </div>
        }

        @if (!string.IsNullOrEmpty(mensaje))
        {
            <p>@mensaje</p>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private Factura? factura;
    private Factura? facturaOriginal;
    private bool modoEdicion = false;
    private string mensaje = "";
    private bool navegacionConfirmada = false;
    private bool accesoNoAutorizado = false;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        // Validar acceso antes de cargar la factura
        var accesoAutorizado = await NavService.ValidarYAutorizarAsync(Id, Token);

        if (!accesoAutorizado)
        {
            Console.WriteLine($"[Factura] Acceso denegado para factura {Id} con token: {Token}");
            accesoNoAutorizado = true;
            cargando = false;
            return;
        }

        Console.WriteLine($"[Factura] Acceso autorizado para factura {Id}");
        await CargarFactura();
        Navigation.LocationChanged += OnLocationChanged;
        cargando = false;
    }

    private async Task CargarFactura()
    {
        factura = await DbContext.Facturas
            .Include(f => f.Articulos)
            .AsNoTracking()
            .FirstOrDefaultAsync(f => f.Id == Id);
    }

    private async void HabilitarEdicion()
    {
        modoEdicion = true;
        mensaje = "";
        GuardarEstadoOriginal();
        await HabilitarInterceptorNavegacion();
    }

    private void GuardarEstadoOriginal()
    {
        if (factura != null)
        {
            facturaOriginal = new Factura
            {
                Id = factura.Id,
                NombreCliente = factura.NombreCliente,
                Fecha = factura.Fecha,
                Articulos = factura.Articulos.Select(a => new Articulo
                {
                    Id = a.Id,
                    Nombre = a.Nombre,
                    Precio = a.Precio,
                    FacturaId = a.FacturaId
                }).ToList()
            };
        }
    }

    private bool TieneCambios()
    {
        if (!modoEdicion || factura == null || facturaOriginal == null)
            return false;

        if (factura.NombreCliente != facturaOriginal.NombreCliente)
            return true;

        if (factura.Fecha != facturaOriginal.Fecha)
            return true;

        if (factura.Articulos.Count != facturaOriginal.Articulos.Count)
            return true;

        for (int i = 0; i < factura.Articulos.Count; i++)
        {
            var artActual = factura.Articulos[i];
            var artOriginal = facturaOriginal.Articulos.FirstOrDefault(a => a.Id == artActual.Id);

            if (artOriginal == null)
                return true;

            if (artActual.Nombre != artOriginal.Nombre || artActual.Precio != artOriginal.Precio)
                return true;
        }

        return false;
    }

    private async void CancelarEdicion()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas descartar los cambios?");

            if (!confirmar)
                return;
        }

        await FinalizarCancelacion();
    }

    private async Task FinalizarCancelacion()
    {
        modoEdicion = false;
        mensaje = "";
        await DeshabilitarInterceptorNavegacion();
        await CargarFactura();
        StateHasChanged();
    }

    private async Task GuardarCambios()
    {
        mensaje = "";

        if (string.IsNullOrWhiteSpace(factura.NombreCliente))
        {
            mensaje = "Debe ingresar el nombre del cliente";
            return;
        }

        var articulosValidos = factura.Articulos.Where(a =>
            !string.IsNullOrWhiteSpace(a.Nombre) && a.Precio > 0).ToList();

        if (!articulosValidos.Any())
        {
            mensaje = "Debe haber al menos un artículo válido";
            return;
        }

        factura.Articulos = articulosValidos;

        var facturaDb = await DbContext.Facturas
            .Include(f => f.Articulos)
            .FirstOrDefaultAsync(f => f.Id == Id);

        if (facturaDb != null)
        {
            facturaDb.NombreCliente = factura.NombreCliente;
            facturaDb.Fecha = factura.Fecha;

            DbContext.Articulos.RemoveRange(facturaDb.Articulos);
            facturaDb.Articulos = factura.Articulos.Select(a => new Articulo
            {
                Nombre = a.Nombre,
                Precio = a.Precio,
                FacturaId = factura.Id
            }).ToList();

            await DbContext.SaveChangesAsync();
        }

        mensaje = "Factura actualizada exitosamente";
        modoEdicion = false;
        await CargarFactura();
        await DeshabilitarInterceptorNavegacion();
    }

    private void AgregarArticulo()
    {
        factura.Articulos.Add(new Articulo { FacturaId = factura.Id });
    }

    private void EliminarArticulo(Articulo art)
    {
        if (factura.Articulos.Count > 1)
        {
            factura.Articulos.Remove(art);
        }
        else
        {
            mensaje = "Debe haber al menos un artículo";
        }
    }

    private async void IrAFacturas()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        // Limpiar el token antes de salir
        NavService.RevocarAutorizacion(Id);
        Navigation.NavigateTo("/facturas");
    }

    private async void IrAHome()
    {
        if (TieneCambios())
        {
            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (!confirmar)
                return;

            await DeshabilitarInterceptorNavegacion();
        }

        // Limpiar el token antes de salir
        NavService.RevocarAutorizacion(Id);
        Navigation.NavigateTo("/");
    }

    private bool procesandoNavegacion = false;

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (procesandoNavegacion)
            return;

        if (e.Location.Contains($"/factura/{Id}"))
            return;

        if (modoEdicion && TieneCambios() && !navegacionConfirmada)
        {
            procesandoNavegacion = true;
            Navigation.NavigateTo($"/factura/{Id}", false);

            bool confirmar = await JS.InvokeAsync<bool>("confirm",
                "Tienes cambios sin guardar. ¿Deseas salir sin guardar?");

            if (confirmar)
            {
                navegacionConfirmada = true;
                await DeshabilitarInterceptorNavegacion();
                NavService.RevocarAutorizacion(Id);
                Navigation.NavigateTo(e.Location);
            }

            procesandoNavegacion = false;
        }
    }

    private async Task HabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = false;
        await JS.InvokeVoidAsync("eval", @"
            window.beforeUnloadHandler = function(e) {
                e.preventDefault();
                e.returnValue = 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
                return 'Tienes cambios sin guardar. ¿Deseas salir sin guardar?';
            };
            window.addEventListener('beforeunload', window.beforeUnloadHandler);
        ");
    }

    private async Task DeshabilitarInterceptorNavegacion()
    {
        navegacionConfirmada = true;
        await JS.InvokeVoidAsync("eval", @"
            if (window.beforeUnloadHandler) {
                window.removeEventListener('beforeunload', window.beforeUnloadHandler);
                window.beforeUnloadHandler = null;
            }
        ");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
        _ = DeshabilitarInterceptorNavegacion();

        // Limpiar token al salir
        if (!accesoNoAutorizado)
        {
            NavService.RevocarAutorizacion(Id);
        }
    }
}