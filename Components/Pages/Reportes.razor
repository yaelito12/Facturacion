@page "/reportes"
@using Facturacion.Data
@using Microsoft.EntityFrameworkCore
@inject FacturacionDbContext DbContext
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<link rel="stylesheet" href="/css/m3-styles.css" />

<div class="m3-container">
    <h1>📊 Reportes para el SAT</h1>

    <div class="m3-button-group">
        <button class="m3-button m3-button-outlined" @onclick="IrAHome">← Volver a Nueva Factura</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAFacturas">📋 Ver Facturas</button>
        <button class="m3-button m3-button-outlined" @onclick="IrAConsultas">🔍 Ver Consultas</button>
    </div>

    <div class="m3-card m3-card-elevated">
        <h3>Seleccionar Año</h3>
        @if (!añosDisponibles.Any())
        {
            <div class="m3-message m3-message-error">
                <strong>No hay facturas registradas en el sistema</strong>
            </div>
        }
        else
        {
            <div style="display: flex; gap: 12px; align-items: end;">
                <div class="m3-text-field" style="flex: 1;">
                    <label>Año:</label>
                    <select @bind="añoSeleccionado" @bind:after="OnAñoSeleccionadoChanged">
                        @foreach (var año in añosDisponibles)
                        {
                            <option value="@año">@año</option>
                        }
                    </select>
                </div>
                <button class="m3-button m3-button-filled" @onclick="CargarReporte">
                    📈 Mostrar Reporte
                </button>
            </div>
        }
    </div>

    @if (reporteCargado)
    {
        @if (!reporteMensual.Any())
        {
            <div class="m3-message m3-message-error">
                <strong>No hay facturas registradas para el año @añoSeleccionado</strong>
            </div>
        }
        else
        {
            <div class="m3-card m3-card-elevated">
                <h2>Reporte del Año @añoSeleccionado</h2>

                <div style="padding: 0; overflow: hidden; border-radius: var(--md-sys-shape-corner-medium);">
                    <table class="m3-table">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th style="text-align: center;">Cantidad de Facturas</th>
                                <th style="text-align: right;">Total del Mes</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var reporte in reporteMensual)
                            {
                                <tr>
                                    <td><strong>@reporte.NombreMes</strong></td>
                                    <td style="text-align: center;">
                                        <span class="m3-chip">@reporte.CantidadFacturas</span>
                                    </td>
                                    <td style="text-align: right;"><strong>$@reporte.TotalMes.ToString("N2")</strong></td>
                                    <td style="text-align: center;">
                                        <button class="m3-button m3-button-tonal" @onclick="() => MostrarDetallesMes(reporte.NumeroMes)">
                                            👁️ Ver Facturas
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <td><strong>TOTAL ANUAL</strong></td>
                                <td style="text-align: center;">
                                    <strong>@reporteMensual.Sum(r => r.CantidadFacturas)</strong>
                                </td>
                                <td style="text-align: right;">
                                    <strong>$@reporteMensual.Sum(r => r.TotalMes).ToString("N2")</strong>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            @if (mesSeleccionado.HasValue && facturasDelMes.Any())
            {
                <div class="m3-card" style="background-color: var(--md-sys-color-surface-container-high);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin: 0;">Detalle de Facturas - @ObtenerNombreMes(mesSeleccionado.Value) @añoSeleccionado</h3>
                        <button class="m3-button m3-button-outlined" @onclick="CerrarDetalleMes">
                            ✕ Cerrar
                        </button>
                    </div>

                    <div style="padding: 0; overflow: hidden; border-radius: var(--md-sys-shape-corner-medium);">
                        <table class="m3-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th style="text-align: right;">Total</th>
                                    <th style="text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var factura in facturasDelMes)
                                {
                                    <tr>
                                        <td><strong>#@factura.Id</strong></td>
                                        <td>@factura.Fecha.ToString("dd/MM/yyyy")</td>
                                        <td>@factura.NombreCliente</td>
                                        <td style="text-align: right;"><strong>$@factura.Total.ToString("N2")</strong></td>
                                        <td style="text-align: center;">
                                            <button class="m3-button m3-button-tonal" @onclick="() => MostrarArticulosFactura(factura.Id)">
                                                📦 Ver Artículos
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4"><strong>TOTAL DEL MES</strong></td>
                                    <td style="text-align: right;">
                                        <strong>$@facturasDelMes.Sum(f => f.Total).ToString("N2")</strong>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                @if (facturaSeleccionada != null && articulosFactura.Any())
                {
                    <div class="m3-card m3-card-elevated">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">Artículos de la Factura #@facturaSeleccionada.Id</h3>
                            <button class="m3-button m3-button-outlined" @onclick="CerrarArticulosFactura">
                                ✕ Cerrar
                            </button>
                        </div>

                        <div style="padding: 0; overflow: hidden; border-radius: var(--md-sys-shape-corner-medium);">
                            <table class="m3-table">
                                <thead>
                                    <tr>
                                        <th>Artículo</th>
                                        <th style="text-align: right;">Precio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var articulo in articulosFactura)
                                    {
                                        <tr>
                                            <td><strong>@articulo.Nombre</strong></td>
                                            <td style="text-align: right;">$@articulo.Precio.ToString("N2")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td><strong>TOTAL</strong></td>
                                        <td style="text-align: right;">
                                            <strong>$@articulosFactura.Sum(a => a.Precio).ToString("N2")</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                }
            }
        }
    }
</div>

@code {
    private int añoSeleccionado;
    private List<int> añosDisponibles = new();
    private List<ReporteMensual> reporteMensual = new();
    private bool reporteCargado = false;
    private int? mesSeleccionado = null;
    private List<Factura> facturasDelMes = new();
    private Factura? facturaSeleccionada = null;
    private List<Articulo> articulosFactura = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarAñosDisponibles();

        // Solo asignar año actual si hay años disponibles
        if (añosDisponibles.Any())
        {
            añoSeleccionado = añosDisponibles.Contains(DateTime.Now.Year)
                ? DateTime.Now.Year
                : añosDisponibles.First();
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var estadoRestaurado = false;

            // Restaurar año seleccionado
            var añoGuardadoStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "reportes_año_seleccionado");
            if (!string.IsNullOrEmpty(añoGuardadoStr) && int.TryParse(añoGuardadoStr, out int añoGuardado))
            {
                if (añosDisponibles.Contains(añoGuardado))
                {
                    añoSeleccionado = añoGuardado;
                    await CargarReporte();
                    estadoRestaurado = true;
                }
            }

            // Restaurar mes seleccionado (solo si hay año)
            if (estadoRestaurado)
            {
                var mesGuardadoStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "reportes_mes_seleccionado");
                if (!string.IsNullOrEmpty(mesGuardadoStr) && int.TryParse(mesGuardadoStr, out int mesGuardado))
                {
                    await MostrarDetallesMes(mesGuardado);

                    // Restaurar factura seleccionada (solo si hay mes)
                    var facturaGuardadaStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "reportes_factura_seleccionada");
                    if (!string.IsNullOrEmpty(facturaGuardadaStr) && int.TryParse(facturaGuardadaStr, out int facturaGuardada))
                    {
                        await MostrarArticulosFactura(facturaGuardada);
                    }
                }
            }

            StateHasChanged();
        }
    }

    private async Task CargarAñosDisponibles()
    {
        var facturas = await DbContext.Facturas.ToListAsync();

        if (facturas.Any())
        {
            // Obtener solo los años que tienen facturas
            añosDisponibles = facturas
                .Select(f => f.Fecha.Year)
                .Distinct()
                .OrderByDescending(a => a)
                .ToList();
        }
        else
        {
            // No hay facturas, lista vacía
            añosDisponibles = new List<int>();
        }
    }

    private async Task OnAñoSeleccionadoChanged()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "reportes_año_seleccionado", añoSeleccionado.ToString());
        await CargarReporte();
    }

    private async Task CargarReporte()
    {
        reporteMensual.Clear();
        mesSeleccionado = null;
        facturasDelMes.Clear();

        var facturas = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => f.Fecha.Year == añoSeleccionado)
            .ToListAsync();

        var facturasPorMes = facturas
            .GroupBy(f => f.Fecha.Month)
            .OrderBy(g => g.Key)
            .ToList();

        foreach (var grupo in facturasPorMes)
        {
            reporteMensual.Add(new ReporteMensual
            {
                NumeroMes = grupo.Key,
                NombreMes = ObtenerNombreMes(grupo.Key),
                CantidadFacturas = grupo.Count(),
                TotalMes = grupo.Sum(f => f.Total)
            });
        }

        reporteCargado = true;

        // Limpiar mes y factura guardados cuando se carga un nuevo reporte
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "reportes_mes_seleccionado");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "reportes_factura_seleccionada");
    }

    private async Task MostrarDetallesMes(int mes)
    {
        mesSeleccionado = mes;
        facturaSeleccionada = null;
        articulosFactura.Clear();

        facturasDelMes = await DbContext.Facturas
            .Include(f => f.Articulos)
            .Where(f => f.Fecha.Year == añoSeleccionado && f.Fecha.Month == mes)
            .OrderBy(f => f.Fecha)
            .ToListAsync();

        // Guardar mes seleccionado en localStorage
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "reportes_mes_seleccionado", mes.ToString());
    }

    private async Task MostrarArticulosFactura(int facturaId)
    {
        facturaSeleccionada = facturasDelMes.FirstOrDefault(f => f.Id == facturaId);
        if (facturaSeleccionada != null)
        {
            articulosFactura = facturaSeleccionada.Articulos.ToList();

            // Guardar factura seleccionada en localStorage
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "reportes_factura_seleccionada", facturaId.ToString());
        }
    }

    private async Task CerrarArticulosFactura()
    {
        facturaSeleccionada = null;
        articulosFactura.Clear();

        // Limpiar factura guardada en localStorage
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "reportes_factura_seleccionada");
    }

    private async Task CerrarDetalleMes()
    {
        mesSeleccionado = null;
        facturasDelMes.Clear();
        facturaSeleccionada = null;
        articulosFactura.Clear();

        // Limpiar mes y factura guardados en localStorage
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "reportes_mes_seleccionado");
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "reportes_factura_seleccionada");
    }

    private string ObtenerNombreMes(int mes)
    {
        return mes switch
        {
            1 => "Enero",
            2 => "Febrero",
            3 => "Marzo",
            4 => "Abril",
            5 => "Mayo",
            6 => "Junio",
            7 => "Julio",
            8 => "Agosto",
            9 => "Septiembre",
            10 => "Octubre",
            11 => "Noviembre",
            12 => "Diciembre",
            _ => "Desconocido"
        };
    }

    private void IrAHome()
    {
        Navigation.NavigateTo("/");
    }

    private void IrAFacturas()
    {
        Navigation.NavigateTo("/facturas");
    }

    private void IrAConsultas()
    {
        Navigation.NavigateTo("/consultas");
    }

    public class ReporteMensual
    {
        public int NumeroMes { get; set; }
        public string NombreMes { get; set; } = "";
        public int CantidadFacturas { get; set; }
        public decimal TotalMes { get; set; }
    }
}